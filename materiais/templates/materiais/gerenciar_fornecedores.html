{% extends 'materiais/base.html' %}
{% block title %}Gerenciar Fornecedores{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .summary-card { padding: 1.5rem; transition: all 0.2s; border: 1px solid #e9ecef; background-color: #fff; border-radius: 8px; }
    .summary-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .badge-access { font-size: 0.75rem; padding: 0.4rem 0.6rem; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; }
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center">
        <a href="{% url 'materiais:dashboard' %}" class="btn btn-secondary me-3"><i class="fas fa-arrow-left"></i> Voltar</a>
        <div>
            <h4 class="mb-0">Gerenciar Fornecedores</h4>
            <p class="text-muted mb-0">Painel administrativo de parceiros e acessos ao portal</p>
        </div>
    </div>
</div>
<hr class="mb-4">

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-white border-bottom py-3">
        <h5 class="mb-0 text-dark"><i class="fas fa-plus-circle me-2 text-success"></i>Novo Fornecedor</h5>
    </div>
    <div class="card-body p-4">
        <form method="post" id="formFornecedor">
            {% csrf_token %}
            <h6 class="text-primary fw-bold mb-3"><i class="fas fa-building me-2"></i>DADOS DA EMPRESA</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold small text-muted">NOME FANTASIA *</label>
                    <input type="text" class="form-control shadow-sm" name="nome_fantasia" required>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label fw-bold small text-muted">RAZÃO SOCIAL *</label>
                    <input type="text" class="form-control shadow-sm" name="razao_social" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold small text-muted">CNPJ *</label>
                    <input type="text" class="form-control shadow-sm" id="cnpj_cadastro" name="cnpj" placeholder="00.000.000/0000-00" required>
                </div>
            </div>

            <div class="row align-items-end">
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold small text-muted">TIPO *</label>
                    <select class="form-select shadow-sm" name="tipo" required>
                        <option value="material">Material</option>
                        <option value="servico">Serviço</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
                <div class="col-md-9 mb-3">
                    <label class="form-label fw-bold small text-muted">CATEGORIAS DE FORNECIMENTO</label>
                    <div class="input-group shadow-sm">
                        <select class="form-select" id="categoria_select">
                            <option value="">Pesquisar categorias...</option>
                            {% for cat in categorias_principais %}
                                <option value="{{ cat.id }}">{{ cat.nome }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary" type="button" id="adicionar_produto_btn" disabled><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <div id="produtos_selecionados_container" class="border p-3 rounded bg-light mb-3 d-flex flex-wrap gap-2" style="min-height: 50px;">
                <span class="text-muted small" id="placeholder_produtos">Nenhuma categoria selecionada.</span>
            </div>
            <input type="hidden" name="produtos_fornecidos" id="produtos_fornecidos_hidden">

            <h6 class="mt-4 text-primary fw-bold mb-3"><i class="fas fa-user-tie me-2"></i>CONTATO E ENDEREÇO</h6>
            <div class="row">
                <div class="col-md-3 mb-3"><label class="form-label small fw-bold text-muted">E-MAIL</label><input type="email" class="form-control shadow-sm" name="email"></div>
                <div class="col-md-3 mb-3"><label class="form-label small fw-bold text-muted">NOME DO CONTATO</label><input type="text" class="form-control shadow-sm" name="contato_nome"></div>
                <div class="col-md-3 mb-3"><label class="form-label small fw-bold text-muted">TELEFONE FIXO</label><input type="text" class="form-control shadow-sm" id="contato_telefone" name="contato_telefone"></div>
                <div class="col-md-3 mb-3"><label class="form-label small fw-bold text-muted">WHATSAPP / CELULAR</label><input type="text" class="form-control shadow-sm" id="contato_whatsapp" name="contato_whatsapp"></div>
            </div>
            
            <div class="row">
                <div class="col-md-2 mb-3"><label class="form-label small fw-bold text-muted">CEP</label><input type="text" class="form-control shadow-sm" id="cep" name="cep"></div>
                <div class="col-md-5 mb-3"><label class="form-label small fw-bold text-muted">LOGRADOURO</label><input type="text" class="form-control shadow-sm" name="logradouro"></div>
                <div class="col-md-2 mb-3"><label class="form-label small fw-bold text-muted">Nº</label><input type="text" class="form-control shadow-sm" name="numero"></div>
                <div class="col-md-3 mb-3"><label class="form-label small fw-bold text-muted">BAIRRO</label><input type="text" class="form-control shadow-sm" name="bairro"></div>
            </div>

            <div class="row">
                <div class="col-md-9 mb-3"><label class="form-label small fw-bold text-muted">CIDADE *</label><input type="text" class="form-control shadow-sm" name="cidade" required></div>
                <div class="col-md-3 mb-3"><label class="form-label small fw-bold text-muted">ESTADO (UF) *</label><input type="text" class="form-control shadow-sm" name="estado" maxlength="2" placeholder="Ex: PI" required></div>
            </div>

            <hr class="my-4">
            <h6 class="text-danger fw-bold mb-3"><i class="fas fa-user-lock me-2"></i>CREDENCIAIS DO PORTAL</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold small text-muted">UTILIZADOR (LOGIN) *</label>
                    <input type="text" name="username_fornecedor" class="form-control shadow-sm border-danger" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold small text-muted">SENHA *</label>
                    <div class="input-group shadow-sm">
                        <input type="password" name="senha_fornecedor" id="senha_fornecedor" class="form-control border-danger" required>
                        <button class="btn btn-outline-danger" type="button" onclick="togglePassword('senha_fornecedor')"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-success mt-3 px-5 shadow">
                <i class="fas fa-save me-2"></i>CADASTRAR E ATIVAR ACESSO
            </button>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-list me-2"></i>BASE DE FORNECEDORES</h6>
        <span class="badge bg-primary">{{ fornecedores.count }} Total</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">FORNECEDOR</th>
                        <th>CNPJ</th>
                        <th>ACESSO PORTAL</th>
                        <th>STATUS</th>
                        <th class="text-end pe-4">GESTÃO</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in fornecedores %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold">{{ f.nome_fantasia }}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">{{ f.cidade }}/{{ f.estado }}</div>
                        </td>
                        <td class="small">{{ f.cnpj }}</td>
                        <td>
                            {% with u=f.usuarios_fornecedor.first %}
                                {% if u %}
                                    <span class="badge bg-info-subtle text-info border border-info-subtle badge-access">
                                        <i class="fas fa-user-circle me-1"></i>{{ u.username }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary border badge-access">Sem acesso</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% if f.ativo %}
                                <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">Ativo</span>
                            {% else %}
                                <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">Inativo</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            <div class="btn-group gap-1">
                                <a href="{% url 'materiais:editar_fornecedor' f.id %}" class="btn btn-action btn-outline-primary" title="Editar Cadastro"><i class="fas fa-pen fa-xs"></i></a>
                                <button onclick="abrirModalAcesso('{{ f.id }}', '{{ f.usuarios_fornecedor.first.username }}')" class="btn btn-action btn-outline-dark" title="Alterar Login/Senha"><i class="fas fa-key fa-xs"></i></button>
                                <button onclick="toggleStatus('{{ f.id }}', '{{ f.ativo|yesno:'false,true' }}')" class="btn btn-action {% if f.ativo %}btn-outline-warning{% else %}btn-outline-success{% endif %}" title="Ativar/Inativar"><i class="fas {% if f.ativo %}fa-pause{% else %}fa-play{% endif %} fa-xs"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center py-4 text-muted">Nenhum fornecedor cadastrado.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarAcesso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white border-0">
                <h5 class="modal-title small fw-bold text-uppercase"><i class="fas fa-shield-alt me-2 text-warning"></i>Segurança do Acesso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarAcesso">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div id="modal_error_msg" class="alert alert-danger d-none small"></div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">UTILIZADOR DO PORTAL</label>
                        <input type="text" name="novo_username" id="edit_username" class="form-control shadow-sm" required>
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-bold small text-muted">DEFINIR NOVA SENHA</label>
                        <div class="input-group shadow-sm">
                            <input type="password" name="nova_senha" id="edit_password" class="form-control" placeholder="Deixe vazio para manter atual">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('edit_password')"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light rounded-bottom">
                    <button type="button" class="btn btn-link text-muted text-decoration-none small" data-bs-dismiss="modal">CANCELAR</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">GUARDAR ALTERAÇÕES</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
$(function() {
    // Aplicação de Máscaras (Consistente com a Edição)
    $('#cnpj_cadastro').mask('00.000.000/0000-00');
    $('#cep').mask('00000-000');
    $('#contato_telefone').mask('(00) 0000-0000');
    $('#contato_whatsapp').mask('(00) 00000-0000');
    
    // Lógica de Categorias
    let selecionados = [];
    $('#categoria_select').select2({ width: '100%' });
    $('#categoria_select').on('change', function() { $('#adicionar_produto_btn').prop('disabled', !$(this).val()); });

    $('#adicionar_produto_btn').click(function() {
        const id = $('#categoria_select').val();
        const nome = $('#categoria_select option:selected').text();
        if (id && !selecionados.some(x => x.id == id)) {
            selecionados.push({ id, nome });
            renderizarChips();
        }
        $('#categoria_select').val('').trigger('change');
    });

    function renderizarChips() {
        const container = $('#produtos_selecionados_container');
        if (selecionados.length === 0) {
            container.html('<span class="text-muted small">Nenhuma categoria selecionada.</span>');
            return;
        }
        container.html(selecionados.map(i => `
            <div class="badge bg-white text-dark border p-2 shadow-sm d-flex align-items-center">
                ${i.nome} <i class="fas fa-times ms-2 text-danger" style="cursor:pointer" onclick="removerChip('${i.id}')"></i>
            </div>
        `).join(''));
        $('#produtos_fornecidos_hidden').val(selecionados.map(x => x.id).join(','));
    }

    window.removerChip = (id) => { selecionados = selecionados.filter(x => x.id != id); renderizarChips(); };

    // Submissão do Modal de Acesso via AJAX (Blindagem contra recarregamento)
    $('#formEditarAcesso').on('submit', function(e) {
        e.preventDefault();
        const btn = $(this).find('button[type="submit"]');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Salvando...');
        
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: $(this).serialize(),
            success: function(res) {
                if (res.success) {
                    location.reload();
                } else {
                    $('#modal_error_msg').removeClass('d-none').text(res.message);
                    btn.prop('disabled', false).text('GUARDAR ALTERAÇÕES');
                }
            }
        });
    });
});

function togglePassword(id) {
    const el = document.getElementById(id);
    el.type = el.type === "password" ? "text" : "password";
}

function abrirModalAcesso(id, user) {
    $('#modal_error_msg').addClass('d-none');
    $('#edit_password').val('');
    const form = document.getElementById('formEditarAcesso');
    form.action = `/fornecedores/${id}/editar-acesso/`;
    document.getElementById('edit_username').value = user;
    new bootstrap.Modal(document.getElementById('modalEditarAcesso')).show();
}

function toggleStatus(id, novoStatus) {
    if (confirm('Deseja realmente alterar o status deste fornecedor?')) {
        $.post(`{% url 'materiais:alterar_status_fornecedor' 0 %}`.replace('0', id), {
            'ativo': novoStatus,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        }, (res) => res.success ? location.reload() : alert(res.message));
    }
}
</script>
{% endblock %}