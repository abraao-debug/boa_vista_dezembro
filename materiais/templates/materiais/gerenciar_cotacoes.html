{% extends 'materiais/base.html' %}
{% block title %}Pedidos de Cotação{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    {% include 'materiais/styles_dashboard.css' %}
    .summary-card { padding: 0.75rem; transition: all 0.2s ease-in-out; border: 1px solid #e9ecef; background-color: #fff; cursor: pointer; }
    .summary-card .count { font-size: 2rem; }
    .summary-card .title { font-size: 0.9em; margin-top: 0.25rem; }
    .summary-link.active .summary-card { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); filter: brightness(95%); }
    .summary-link { color: #212529; text-decoration: none; display: block; }
    .sc-card { border-left: 4px solid #0d6efd; }
    .label-mini { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; font-weight: bold; margin-bottom: 0.2rem; }
    .btn-sm { font-size: 0.85rem !important; padding: 0.35rem 0.75rem !important; font-weight: 500; }

    /* Estilos de Suavização e Auditoria (Item Solicitado) */
    .modal-header-suave { background-color: #ffffff !important; color: #333333 !important; border-bottom: 1px solid #dee2e6 !important; }
    .modal-header-suave .btn-close { filter: none !important; }
    .audit-popup { position: absolute; right: 0; z-index: 1000; }
    .audit-container { position: relative; }
    .disparo-item { border-left: 4px solid #dee2e6; transition: all 0.2s; }
    .disparo-item.ready { border-left-color: #198754; background-color: #f8fff9; }
    /* Garantir que o modal de confirmação de vencedor role corretamente e o footer fique visível */
    /* Aumentado para ocupar mais altura vertical na tela */
    #confirmarVencedorModal .modal-body { max-height: calc(92vh - 200px); overflow-y: auto; }
    #confirmarVencedorModal .modal-footer { background: #f8f9fa; }
</style>

<div class="d-flex align-items-center mb-3">
    <a href="{% url 'materiais:dashboard' %}" class="btn btn-secondary me-3"><i class="fas fa-arrow-left"></i> Voltar</a>
    <div>
        <h4 class="mb-0">Pedidos de Cotação</h4>
        <p class="text-muted mb-0 small">Gerencie as cotações das solicitações de compra de forma unificada e segura.</p>
    </div>
</div>
<hr class="mb-4">

<div class="row mb-4 nav nav-tabs border-0" id="summaryCardNav" role="tablist">
    <div class="col-md-4 col-12 mb-3">
        <a href="#iniciar-cotacao" class="summary-link active" data-bs-toggle="tab" data-bs-target="#iniciar-cotacao" role="tab">
            <div class="status-card summary-card status-aprovado">
                <span class="count">{{ scs_para_iniciar.count }}</span>
                <p class="title"><i class="fas fa-play-circle status-icon"></i> Para Iniciar</p>
            </div>
        </a>
    </div>
    <div class="col-md-4 col-12 mb-3">
        <a href="#aguardando" class="summary-link" data-bs-toggle="tab" data-bs-target="#aguardando" role="tab">
            <div class="status-card summary-card status-cotacao">
                <span class="count">{{ aguardando_resposta_count }}</span>
                <p class="title"><i class="fas fa-envelope-open-text status-icon"></i> Em Cotação</p>
            </div>
        </a>
    </div>
    <div class="col-md-4 col-12 mb-3">
        <a href="#recebidas" class="summary-link" data-bs-toggle="tab" data-bs-target="#recebidas" role="tab">
            <div class="status-card summary-card status-requisicoes">
                <span class="count">{{ scs_recebidas_count }}</span>
                <p class="title"><i class="fas fa-check-circle status-icon"></i> Cotações Recebidas</p>
            </div>
        </a>
    </div>
</div>

<div class="tab-content" id="cotacoesTabContent">
    <div class="tab-pane fade show active p-3" id="iniciar-cotacao" role="tabpanel">
        {% for sc in scs_para_iniciar %}
        <div class="card mb-3 sc-card" style="border-left-color: {% if sc.tem_envios_parciais %}#ffc107{% else %}#198754{% endif %};">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <h5 class="mb-1 text-dark fw-normal">
                            {{ sc.nome_descritivo }}
                            {% if sc.tem_envios_parciais %}
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">
                                <i class="fas fa-exclamation-triangle me-1"></i>ENVIO PARCIAL
                            </span>
                            {% endif %}
                        </h5>
                        <div class="d-flex flex-wrap gap-3 text-muted small mt-2">
                            <span><strong>Código:</strong> {{ sc.numero }}</span>
                            <span><strong>Obra:</strong> {{ sc.obra.nome }}</span>
                            <span><i class="fas fa-calendar-alt"></i> <strong>Necessário:</strong> {{ sc.data_necessidade|date:"d/m/Y" }}</span>
                            {% if sc.tem_envios_parciais %}
                            <span class="text-warning"><i class="fas fa-list-check"></i> <strong>Itens Enviados:</strong> {{ sc.itens_enviados_count }}/{{ sc.total_itens }}</span>
                            {% endif %}
                        </div>
                        {% if sc.tem_envios_parciais %}
                        <div class="mt-2">
                            <button class="btn btn-xs btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#itensPendentes{{ sc.id }}">
                                <i class="fas fa-eye me-1"></i>Ver Itens Pendentes
                            </button>
                            <div class="collapse mt-2" id="itensPendentes{{ sc.id }}">
                                <div class="alert alert-warning py-2 px-3 mb-0 small">
                                    <strong>Itens ainda não enviados para cotação:</strong>
                                    <ul class="mb-0 mt-1">
                                        {% for item in sc.itens_pendentes %}
                                        <li>{{ item.descricao }} ({{ item.quantidade|floatformat:"0" }} {{ item.unidade }})</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-5 text-end">
                        <div class="btn-group">
                            <button class="btn btn-sm {% if sc.tem_envios_parciais %}btn-warning{% else %}btn-success{% endif %}" data-bs-toggle="modal" data-bs-target="#solicitarCotacaoModal" data-sc-id="{{ sc.id }}" data-sc-name="{{ sc.nome_descritivo }}">
                                {% if sc.tem_envios_parciais %}Continuar Cotação{% else %}Iniciar Cotação{% endif %}
                            </button>
                            <button type="button" class="btn btn-sm {% if sc.tem_envios_parciais %}btn-warning{% else %}btn-success{% endif %} dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
                            <ul class="dropdown-menu shadow">
                                <li><a class="dropdown-item" href="{% url 'materiais:escritorio_editar_sc' sc.id %}">Editar Solicitação</a></li>
                                <li><button class="dropdown-item text-danger" onclick="abrirModalRejeicao('{{ sc.id }}', '{{ sc.nome_descritivo }}')">Rejeitar Solicitação</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalDetalhesSC" data-sc-id="{{ sc.id }}">Ver Detalhes da SC</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}<div class="text-center p-5 text-muted"><h5>Nenhuma solicitação para iniciar.</h5></div>{% endfor %}
    </div>

    <div class="tab-pane fade p-3" id="aguardando" role="tabpanel">
        <div class="mb-5">
            <h5 class="mb-3"><span class="badge bg-danger">Pendente</span> <span class="ms-2">Aguardando Primeiros Preços</span></h5>
            {% for sc in scs_em_cotacao %}
                {% if not sc.cotacoes_recebidas_ids %}
                <div class="card mb-3 sc-card" style="border-left-color: {% if sc.tem_itens_pendentes %}#ffc107{% else %}#dc3545{% endif %};">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-1 text-dark fw-normal">
                                    {{ sc.nome_descritivo }}
                                    {% if sc.tem_itens_pendentes %}
                                    <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>ITENS PENDENTES
                                    </span>
                                    {% endif %}
                                </h5>
                                {% if sc.tem_itens_pendentes %}
                                <div class="alert alert-warning py-1 px-2 mb-0 mt-2 small d-inline-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>{{ sc.itens_enviados_count }}/{{ sc.total_itens }} itens enviados.</strong> 
                                    Faltam {{ sc.itens_pendentes_count }} item{{ sc.itens_pendentes_count|pluralize }} para completar a SC.
                                </div>
                                {% endif %}
                            </div>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#solicitarCotacaoModal" data-sc-id="{{ sc.id }}" data-sc-name="{{ sc.nome_descritivo }}"><i class="fas fa-user-plus me-1"></i> Convidar Fornecedores</button>
                        </div>
                        <div class="bg-light rounded p-3">
                            {% for envio in sc.envios_cotacao.all %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div><strong>{{ envio.fornecedor.nome_fantasia }}</strong><small class="d-block text-muted">Convite enviado em: {{ envio.data_envio|date:"d/m/Y H:i" }}</small></div>
                                <div class="d-flex gap-2 align-items-center">
                                    <a href="{% url 'materiais:iniciar_cotacao_fornecedor' sc.id envio.fornecedor.id %}" class="btn btn-sm btn-warning fw-bold"><i class="fas fa-keyboard me-1"></i> REGISTRAR PREÇO</a>
                                    <span class="btn btn-sm btn-outline-danger disabled" style="opacity: 1; border-style: dashed; font-weight: 600;"><i class="fas fa-hourglass-half me-1"></i> AGUARDANDO</span>
                                    <form action="{% url 'materiais:excluir_envio_cotacao' envio.id %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-sm btn-danger" onclick="abrirModalExclusao(this, 'fornecedor')">EXCLUIR</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                            {% if sc.tem_itens_pendentes %}
                            <div class="mt-3 pt-2 border-top">
                                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#solicitarCotacaoModal" data-sc-id="{{ sc.id }}" data-sc-name="{{ sc.nome_descritivo }}">
                                    <i class="fas fa-plus-circle me-1"></i>Enviar Itens Pendentes
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <hr>
        
        <div class="mt-4">
            <h5 class="mb-3"><span class="badge bg-warning text-dark">Parcialmente Completa</span> <span class="ms-2">Aguardando Demais Fornecedores</span></h5>
            {% for sc in scs_em_cotacao %}
                {% if sc.cotacoes_recebidas_ids %}
                <div class="card mb-3 sc-card" style="border-left-color: #ffc107;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-1 text-dark fw-normal">
                                    {{ sc.nome_descritivo }}
                                    {% if sc.tem_itens_pendentes %}
                                    <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>ITENS PENDENTES
                                    </span>
                                    {% endif %}
                                </h5>
                                {% if sc.tem_itens_pendentes %}
                                <div class="alert alert-warning py-1 px-2 mb-0 mt-2 small d-inline-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>{{ sc.itens_enviados_count }}/{{ sc.total_itens }} itens enviados.</strong> 
                                    Faltam {{ sc.itens_pendentes_count }} item{{ sc.itens_pendentes_count|pluralize }} para completar a SC.
                                </div>
                                {% endif %}
                            </div>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#solicitarCotacaoModal" data-sc-id="{{ sc.id }}" data-sc-name="{{ sc.nome_descritivo }}"><i class="fas fa-user-plus me-1"></i> Convidar Fornecedores</button>
                        </div>
                        <div class="bg-light rounded p-3">
                            {% for envio in sc.envios_cotacao.all %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div><strong>{{ envio.fornecedor.nome_fantasia }}</strong><small class="d-block text-muted">Convite enviado em: {{ envio.data_envio|date:"d/m/Y" }}</small></div>
                                <div class="d-flex gap-2 align-items-center">
                                    {% if envio.fornecedor_id in sc.cotacoes_recebidas_ids %}
                                        <div class="text-end me-2 position-relative audit-container">
                                            <div class="d-flex align-items-center justify-content-end gap-2">
                                                <span class="badge bg-success" style="font-size: 0.8rem;"><i class="fas fa-check-double me-1"></i> PREÇO RECEBIDO</span>
                                                {% for c in sc.cotacoes.all %}
                                                    {% if c.fornecedor_id == envio.fornecedor_id %}
                                                        <button class="btn btn-link btn-sm p-0 text-muted btn-audit-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#audit{{ c.id }}"><i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i></button>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            {% for c in sc.cotacoes.all %}
                                                {% if c.fornecedor_id == envio.fornecedor_id %}
                                                <div class="collapse mt-1 audit-popup" id="audit{{ c.id }}">
                                                    <div class="card card-body p-2 shadow-sm border-success text-start" style="min-width: 190px; background: #f8fff9;">
                                                        <small class="d-block text-muted mb-1" style="font-size: 0.55rem; text-transform: uppercase;">Preenchido por:</small>
                                                        <small class="d-block text-dark fw-bold" style="font-size: 0.7rem;"><i class="fas fa-user-edit me-1 text-success"></i>{% if c.registrado_por %}{{ c.registrado_por.get_full_name|default:c.registrado_por.username }}{% else %}Fornecedor (Portal){% endif %}</small>
                                                        <small class="d-block text-muted mt-1" style="font-size: 0.6rem;"><i class="far fa-clock me-1"></i>{{ c.data_registro|date:"d/m/Y H:i" }}</small>
                                                        <hr class="my-1 opacity-25">
                                                        <small class="d-block text-muted" style="font-size: 0.55rem;">Origem: {{ c.get_origem_display }}</small>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <a href="{% url 'materiais:iniciar_cotacao_fornecedor' sc.id envio.fornecedor.id %}" class="btn btn-sm btn-warning fw-bold"><i class="fas fa-keyboard me-1"></i> REGISTRAR PREÇO</a>
                                        <span class="btn btn-sm btn-outline-danger disabled" style="opacity: 1; border-style: dashed; font-weight: 600;"><i class="fas fa-hourglass-half me-1"></i> AGUARDANDO</span>
                                    {% endif %}
                                    <form action="{% url 'materiais:excluir_envio_cotacao' envio.id %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-sm btn-danger" onclick="abrirModalExclusao(this, 'fornecedor')">EXCLUIR</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="mt-3 pt-2 border-top">
                                <div class="d-flex justify-content-between align-items-center">
                                    {% if sc.tem_itens_pendentes %}
                                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#solicitarCotacaoModal" data-sc-id="{{ sc.id }}" data-sc-name="{{ sc.nome_descritivo }}">
                                        <i class="fas fa-plus-circle me-1"></i>Enviar Itens Pendentes
                                    </button>
                                    {% else %}
                                    <div></div>
                                    {% endif %}
                                    <form action="{% url 'materiais:finalizar_coleta_precos' sc.id %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-primary" onclick="return confirm('Deseja encerrar a fase de coleta? Ao avançar, fornecedores que ainda não responderam não conseguirão mais enviar propostas.');">Finalizar Coleta e Analisar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="tab-pane fade p-3" id="recebidas" role="tabpanel">
        {% for sc in scs_recebidas %}
        <div class="card mb-4 sc-card" style="border-left-color: #198754;">
            <div class="card-header bg-white border-0 pt-3 pb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1 text-dark fw-normal">{{ sc.nome_descritivo }}</h5>
                        <div class="d-flex flex-wrap gap-3 text-muted small">
                            <span><i class="fas fa-building me-1"></i>{{ sc.obra.nome }}</span>
                            <span><i class="fas fa-boxes me-1"></i>{{ sc.itens.count }} ite{{ sc.itens.count|pluralize:"m,ns" }}</span>
                            <span><i class="fas fa-comments me-1"></i>{{ sc.cotacoes.count }} cotaç{{ sc.cotacoes.count|pluralize:"ão,ões" }} recebida{{ sc.cotacoes.count|pluralize }}</span>
                            {% if sc.destino %}
                            <span><i class="fas fa-map-marker-alt me-1"></i>{{ sc.destino.nome }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalDetalhesSC" data-sc-id="{{ sc.id }}">Ver Detalhes</button>
                </div>
            </div>
            <div class="card-body pt-2">
                {% for cotacao in sc.cotacoes.all %}
                <div class="border rounded p-3 mb-3 bg-white shadow-sm cotacao-card" data-cotacao-id="{{ cotacao.id }}">
                    <!-- CABEÇALHO DA COTAÇÃO -->
                    <div class="row align-items-start">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <span class="text-muted me-1">Fornecedor:</span>
                                <h6 class="mb-0 fw-bold text-dark">{{ cotacao.fornecedor.nome_fantasia }}</h6>
                                {% if cotacao.origem == 'portal' %}
                                <span class="badge bg-light text-secondary border ms-2" title="Cotação enviada pelo fornecedor"><i class="fas fa-globe me-1"></i>Portal</span>
                                {% else %}
                                <span class="badge bg-light text-secondary border ms-2" title="Cotação inserida manualmente"><i class="fas fa-edit me-1"></i>Manual</span>
                                {% endif %}
                            </div>
                            
                            <!-- RESUMO DE VALORES -->
                            <div class="d-flex flex-wrap gap-4 align-items-baseline">
                                <div>
                                    <small class="text-muted d-block">Valor Total</small>
                                    <h4 class="mb-0 text-success fw-bold">R$ {{ cotacao.valor_total|floatformat:2 }}</h4>
                                </div>
                                {% if cotacao.valor_frete > 0 %}
                                <div>
                                    <small class="text-muted d-block">Frete</small>
                                    <span class="fw-semibold">R$ {{ cotacao.valor_frete|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                <div>
                                    <small class="text-muted d-block">Qtd. Itens</small>
                                    <span class="fw-semibold">{{ cotacao.itens_cotados.count }}</span>
                                </div>
                            </div>
                            
                            <!-- CONDIÇÕES COMERCIAIS -->
                            <div class="mt-3 p-2 bg-light rounded small">
                                <div class="d-flex flex-wrap justify-content-between gap-3">
                                    <div class="text-nowrap">
                                        <span class="text-muted"><i class="fas fa-truck me-1"></i>Entrega:</span>
                                        <span class="fw-semibold ms-1">{% if cotacao.prazo_entrega and cotacao.prazo_entrega != 'Atende' %}{{ cotacao.prazo_entrega }}{% else %}{{ sc.envios_cotacao.first.data_entrega_solicitada|date:"d/m/Y"|default:"A combinar" }}{% endif %}</span>
                                    </div>
                                    <div class="text-nowrap">
                                        <span class="text-muted"><i class="fas fa-credit-card me-1"></i>Pagamento:</span>
                                        <span class="fw-semibold ms-1">{% if cotacao.condicao_pagamento and cotacao.condicao_pagamento != 'Atende' %}{{ cotacao.condicao_pagamento }}{% else %}{{ sc.envios_cotacao.first.get_forma_pagamento_display }}{% if sc.envios_cotacao.first.prazo_pagamento > 0 %} em {{ sc.envios_cotacao.first.prazo_pagamento }} dias{% endif %}{% endif %}</span>
                                    </div>
                                    <div class="text-nowrap">
                                        <span class="text-muted"><i class="fas fa-clock me-1"></i>Recebida:</span>
                                        <span class="fw-semibold ms-1">{{ cotacao.data_registro|date:"d/m/Y H:i" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#detalhesCotacao{{ cotacao.id }}">
                                    <i class="fas fa-list me-1"></i>Ver Orçamento
                                </button>
                                <button type="button" class="btn btn-sm btn-success w-100 btn-selecionar-vencedora" data-cotacao-id="{{ cotacao.id }}">
                                    <i class="fas fa-trophy me-1"></i>Selecionar Vencedora
                                </button>
                                <form action="{% url 'materiais:rejeitar_cotacao' cotacao.id %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="abrirModalExclusao(this, 'cotação', '{{ cotacao.fornecedor.nome_fantasia }}', {{ cotacao.id }})">
                                        <i class="fas fa-trash me-1"></i>EXCLUIR COTAÇÃO
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- STATUS VISUAL MELHORADO -->
                    <div class="row mt-3">
                        <div class="col-12">
                            {% if cotacao.conformidade == 'verde' %}
                            <div class="alert alert-success mb-0 py-2">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>A proposta atende todos os requisitos solicitados</strong> 
                            </div>
                            {% elif cotacao.conformidade == 'amarelo' %}
                            <div class="alert alert-warning mb-0 py-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Atenção, houve alteração na forma de pagamento.</strong> 
                                <button class="btn btn-sm btn-warning ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#detalheDivergencia{{ cotacao.id }}">
                                    Ver Diferenças
                                </button>
                            </div>
                            {% else %}
                            <div class="alert alert-danger mb-0 py-2">
                                <i class="fas fa-times-circle me-2"></i>
                                <strong>Atenção, data ou endereço de entrega está diferente da condição inicial</strong>
                                <button class="btn btn-sm btn-danger ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#detalheDivergencia{{ cotacao.id }}">
                                    Ver o que mudou
                                </button>
                            </div>
                            {% endif %}
                            
                            <!-- DETALHES DAS DIVERGÊNCIAS -->
                            {% if cotacao.conformidade != 'verde' %}
                            <div class="collapse mt-2" id="detalheDivergencia{{ cotacao.id }}">
                                <div class="card card-body bg-light">
                                    <h6 class="text-danger mb-3"><i class="fas fa-list-ul me-2"></i>Detalhes das Diferenças:</h6>
                                    
                                    <!-- PRAZO DE ENTREGA -->
                                    <div class="mb-3 pb-3 border-bottom">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-calendar-check me-1"></i>DATA SOLICITADA:</small>
                                                <strong class="text-success">{{ sc.envios_cotacao.first.data_entrega_solicitada|date:"d/m/Y"|default:"Prazo flexível" }}</strong>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-truck me-1"></i>DATA FINAL REGISTRADA:</small>
                                                <strong class="{% if cotacao.prazo_entrega == 'Atende' %}text-success{% else %}text-danger{% endif %}">
                                                    {{ cotacao.prazo_entrega }}
                                                </strong>
                                                {% if cotacao.prazo_entrega != 'Atende' %}
                                                <div class="mt-1">
                                                    <small class="text-muted d-block">Motivo:</small>
                                                    <small class="text-danger">{{ cotacao.motivo_divergencia_prazo|default:"Não informado" }}</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- FORMA DE PAGAMENTO -->
                                    <div class="mb-3 pb-3 border-bottom">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-credit-card me-1"></i>CONDIÇÕES DE PAGAMENTO SOLICITADA:</small>
                                                <strong class="text-success">{{ sc.envios_cotacao.first.get_forma_pagamento_display }} em {{ sc.envios_cotacao.first.prazo_pagamento }} dias</strong>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-money-bill-wave me-1"></i>CONDIÇÃO DE PAGAMENTO FINAL:</small>
                                                <strong class="{% if cotacao.condicao_pagamento == 'Atende' %}text-success{% else %}text-warning{% endif %}">
                                                    {{ cotacao.condicao_pagamento }}
                                                </strong>
                                                {% if cotacao.condicao_pagamento != 'Atende' %}
                                                <div class="mt-1">
                                                    <small class="text-muted d-block">Motivo:</small>
                                                    <small class="text-warning">{{ cotacao.motivo_divergencia_pagamento|default:"Não informado" }}</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- LOCAL DE ENTREGA -->
                                    <div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-map-marker-alt me-1"></i>ENDEREÇO DE ENTREGA SOLICITADO:</small>
                                                <strong class="text-success">{% if sc.destino %}{{ sc.destino.nome }}{% else %}{{ sc.obra.nome }}{% endif %}</strong>
                                                <small class="d-block text-muted">{{ sc.destino.endereco|default:sc.obra.endereco }}</small>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-shipping-fast me-1"></i>ENDEREÇO DE ENTREGA FINAL:</small>
                                                <strong class="{% if cotacao.endereco_entrega.id == sc.destino.id or cotacao.endereco_entrega.id == sc.obra.id %}text-success{% else %}text-danger{% endif %}">
                                                    {{ cotacao.endereco_entrega.nome }}
                                                </strong>
                                                <small class="d-block text-muted">{{ cotacao.endereco_entrega.endereco }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="collapse mt-3" id="detalhesCotacao{{ cotacao.id }}">
                        <div class="bg-light p-3 rounded border">
                            <!-- OBSERVAÇÕES DO FORNECEDOR -->
                            {% if cotacao.observacoes %}
                            <div class="alert alert-secondary small mb-3 py-2">
                                <i class="fas fa-comment-alt me-1"></i>
                                <strong>Observações do Fornecedor:</strong>
                                <p class="mb-0 mt-1">{{ cotacao.observacoes }}</p>
                            </div>
                            {% endif %}
                            
                            <!-- TABELA DE ITENS -->
                            <h6 class="text-muted mb-2"><i class="fas fa-list-ul me-1"></i>Itens Cotados</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0 small">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width:45%">Descrição do Item</th>
                                            <th class="text-center" style="width:15%">Quantidade</th>
                                            <th class="text-end" style="width:20%">Preço Unitário</th>
                                            <th class="text-end" style="width:20%">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ic in cotacao.itens_cotados.all %}
                                        <tr>
                                            <td>
                                                <span class="fw-medium">{{ ic.item_solicitacao.descricao }}</span>
                                                {% if ic.item_solicitacao.observacoes %}
                                                <br><small class="text-muted">{{ ic.item_solicitacao.observacoes }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">{{ ic.item_solicitacao.quantidade|floatformat:0 }} {{ ic.item_solicitacao.unidade }}</td>
                                            <td class="text-end">R$ {{ ic.preco|floatformat:2 }}</td>
                                            <td class="text-end fw-bold">R$ {{ ic.get_subtotal|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="3" class="text-end text-muted">Subtotal Itens:</td>
                                            <td class="text-end fw-semibold">R$ {{ cotacao.valor_total|floatformat:2 }}</td>
                                        </tr>
                                        {% if cotacao.valor_frete > 0 %}
                                        <tr>
                                            <td colspan="3" class="text-end text-muted">Frete:</td>
                                            <td class="text-end fw-semibold">R$ {{ cotacao.valor_frete|floatformat:2 }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr class="table-success">
                                            <td colspan="3" class="text-end fw-bold">TOTAL GERAL:</td>
                                            <td class="text-end fw-bold text-success fs-6">R$ {{ cotacao.valor_total|floatformat:2 }}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}<div class="text-center p-5 text-muted"><h5>Nenhuma cotação pronta para análise final.</h5></div>{% endfor %}
    </div>
</div>

{% include 'materiais/_modal_detalhes_sc.html' %}

<div class="modal fade" id="solicitarCotacaoModal" tabindex="-1" aria-labelledby="solicitarCotacaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <form id="formPrepararCotacao">
                <div class="modal-header modal-header-suave py-3">
                    <h5 class="modal-title fw-normal" id="solicitarCotacaoModalLabel">
                        Solicitar Cotação: <span id="sc_name_display" class="fw-medium text-secondary"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-7 border-end">
                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">BUSCAR FORNECEDORES *</label>
                                <select id="fornecedorSelect" name="fornecedor" class="form-control" style="width: 100%;" required></select>
                                <div class="form-text d-flex justify-content-between align-items-center" id="fornecedorCounterRow" style="font-size: 0.7rem;">
                                    <div>
                                        <span id="fornecedorCounter">Nenhum fornecedor selecionado</span>
                                    </div>
                                    <div>
                                        <button type="button" id="btnRemoveSelectedFornecedor" class="btn btn-sm btn-outline-danger d-none">Remover</button>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small fw-bold">PRAZO PARA RESPOSTA *</label>
                                    <input type="date" class="form-control form-control-sm border-light-subtle" name="prazo_resposta" required>
                                    <div class="form-text text-danger" style="font-size: 0.65rem;">* Obrigatório para prosseguir.</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small fw-bold">FORMA DE PAGAMENTO *</label>
                                    <select class="form-select form-select-sm border-light-subtle" name="forma_pagamento" required>
                                        <option value="" selected disabled>Selecione a forma de pagamento</option>
                                        {% for valor, label in formas_pagamento %}
                                            <option value="{{ valor }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text text-danger" style="font-size: 0.65rem;">* Obrigatório para prosseguir.</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">PRAZO DE PAGAMENTO (DIAS) *</label>
                                <input type="number" class="form-control form-control-sm border-light-subtle" name="prazo_pagamento" id="prazo_pagamento_input" placeholder="Ex: 28" required>
                                <div class="form-text text-danger" style="font-size: 0.65rem;">* Obrigatório definir o prazo para prosseguir.</div>
                            </div>

                            <!-- Aviso para bloquear preenchimento de condições quando um fornecedor já tem envio anterior -->
                            <div id="negociacaoBlockedNotice" class="alert alert-warning small d-none mt-2" role="alert" style="font-size:0.9rem;"></div>

                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">OBSERVAÇÕES PARA O FORNECEDOR</label>
                                <textarea class="form-control form-control-sm border-light-subtle" name="observacoes" rows="3" placeholder="Ex: Entregar em horário comercial, NF acompanhando material..."></textarea>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <label class="form-label text-muted small fw-bold">ITENS SELECIONADOS *</label>
                            <div id="itensParaCotacaoList" class="border rounded p-2 bg-light-subtle" style="max-height: 380px; overflow-y: auto;">
                                <p class="text-muted text-center py-5 small italic">Carregando itens da solicitação...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0 py-3">
                    <button type="button" class="btn btn-secondary btn-sm px-3" data-bs-dismiss="modal">CANCELAR</button>
                    <button type="submit" id="btnEnviarCotacao" class="btn btn-success btn-sm px-4 fw-bold shadow-sm">ENVIAR COTAÇÃO <i class="fas fa-paper-plane ms-1"></i></button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDisparoIndividual" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-normal"><i class="fas fa-paper-plane me-2"></i>Gerenciar Envio de Convites</h6>
            </div>
            <div class="modal-body p-0">
                <div class="p-3 bg-light border-bottom">
                    <p class="text-muted mb-0 small">Escolha como cada fornecedor deve receber a cotação:</p>
                </div>
                <div id="fornecedorBlockingNotice" class="alert alert-warning small m-3 d-none" role="alert" style="font-size:0.95rem;">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="d-flex align-items-start">
                            <div class="me-2 mt-1"><i class="fas fa-exclamation-triangle fa-lg"></i></div>
                            <div>
                                <strong>Atenção:</strong> Este fornecedor já recebeu todos os itens selecionados.
                                <div class="mt-1">Para enviar itens adicionais, <strong>remova o fornecedor</strong> desta lista ou <strong>exclua o envio anterior</strong> na lista de convites.</div>
                                <div class="mt-2"><small class="text-muted">Dica: clique no fornecedor e use o botão de cancelar/remover convite.</small></div>
                            </div>
                        </div>
                        <div>
                            <button id="btnRemoveBlockedFornecedores" type="button" class="btn btn-sm btn-outline-danger ms-3">
                                <i class="fas fa-user-minus me-1"></i>Remover fornecedor(s) bloqueado(s)
                            </button>
                        </div>
                    </div>
                </div>
                <div id="listaDisparoFornecedores" class="list-group list-group-flush"></div>
            </div>
            <div class="modal-footer bg-light border-0 py-3">
                <div class="d-flex gap-2 w-100">
                    <button type="button" id="btnEmergenciaFechar" class="btn btn-outline-danger btn-sm" title="Fechar e cancelar todas as operações" style="display:none;">
                        <i class="fas fa-times me-1"></i>Sair sem Concluir
                    </button>
                    <button type="button" id="btnConcluirTudo" class="btn btn-success btn-sm w-100 py-2 fw-bold shadow-sm" disabled>
                        <i class="fas fa-check-double me-2"></i>CONCLUIR E FINALIZAR COTAÇÃO
                    </button>
                </div>
                <div id="alertaBloqueioFornecedor" class="alert alert-danger small mt-2 mb-0" style="display:none;">
                    <i class="fas fa-ban me-1"></i><strong>Atenção:</strong> Você não pode prosseguir com um fornecedor que já possui envios anteriores. Por favor, clique em <strong>"Remover"</strong> para selecionar outro fornecedor.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ação Bloqueada (Fornecedor já tem envios) -->
<div class="modal fade" id="modalAcaoBloqueada" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title"><i class="fas fa-ban me-2"></i>Ação Bloqueada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4">
                <div class="text-center mb-3">
                    <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
                </div>
                <p class="text-center mb-3">
                    O fornecedor <strong id="nomeFornecedorBloqueado">-</strong> <strong>JÁ POSSUI ENVIOS ANTERIORES</strong> para esta solicitação.
                </p>
                <div class="bg-light rounded p-3 mb-3">
                    <p class="mb-2 small text-muted">
                        Se você quiser adicionar itens, mudar prazo, formas e pagamento, siga os passos:
                    </p>
                    <ol class="mb-0 small">
                        <li>Vá para a aba <strong>"Em Cotação"</strong> desta página</li>
                        <li>Exclua o convite anterior a esse fornecedor</li>
                        <li>Volte para <strong>Convidar Fornecedores</strong> e selecione o fornecedor novamente</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnRemoverFornecedorBloqueado">
                    Remover Fornecedor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Divergências -->
<div class="modal fade" id="modalDivergencia" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Atenção: Proposta com Diferenças</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Esta cotação <strong>não atende exatamente</strong> o que foi solicitado. 
                    Por favor, revise as diferenças abaixo e forneça uma justificativa para aprovar.
                </div>

                <!-- Tabela de Comparação -->
                <div class="table-responsive mb-4">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th width="25%">ITEM</th>
                                <th width="35%">O QUE VOCÊ PEDIU</th>
                                <th width="40%">O QUE O FORNECEDOR OFERECE</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaComparacaoDivergencias">
                            <!-- Preenchido dinamicamente via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Justificativa Obrigatória -->
                <div class="mb-3">
                    <label class="form-label fw-bold text-danger">
                        <i class="fas fa-pen me-2"></i>JUSTIFICATIVA (Obrigatória) *
                    </label>
                    <textarea id="justificativaDivergencia" class="form-control" rows="4" 
                              placeholder="Por favor, explique detalhadamente por que está aprovando esta cotação mesmo com as diferenças identificadas. Ex: Prazo é aceitável pois há estoque, pagamento negociado é vantajoso, etc."
                              required></textarea>
                    <small class="form-text text-muted">Este texto ficará registrado no sistema para auditoria futura.</small>
                </div>

                <!-- Senha de Confirmação -->
                <div class="mb-3">
                    <label class="form-label fw-bold text-danger">
                        <i class="fas fa-lock me-2"></i>CONFIRME SUA SENHA PARA APROVAR *
                    </label>
                    <input type="password" id="senhaDivergencia" class="form-control" 
                           placeholder="Digite sua senha de acesso ao sistema"
                           required>
                    <small class="form-text text-muted">Por segurança, aprovações de cotações divergentes requerem senha.</small>
                </div>

                <div id="erroDivergencia" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" id="btnConfirmarDivergencia" class="btn btn-warning fw-bold px-4">
                    <i class="fas fa-check me-2"></i>CONFIRMAR E APROVAR
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmarVencedorModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow border-0">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>Gerar Requisição de Material (RM)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formConfirmarVencedor" method="post">
                {% csrf_token %}
                <div class="modal-body" id="confirmarVencedorBody"></div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCELAR</button>
                    <button type="submit" class="btn btn-success px-4 fw-bold"><i class="fas fa-check me-2"></i>GERAR RM OFICIAL</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmação estilizada para prosseguir mesmo com pendentes -->
<div class="modal fade" id="confirmProceedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h6 class="modal-title">Confirmar ação</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmProceedMessage" class="small text-muted mb-0"></p>
                <p class="mt-2 small">Ao confirmar, as cotações pendentes não serão consideradas. Deseja prosseguir?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmProceedBtn" class="btn btn-warning btn-sm">Confirmar e Gerar RM</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-danger text-white border-0 py-2">
                <h6 class="modal-title"><i class="fas fa-trash-alt me-2"></i>Atenção: Ação Crítica</h6>
            </div>
            <div class="modal-body p-4 text-center">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3 opacity-50"></i>
                <h5 class="mb-2 fw-normal">Confirmar Exclusão?</h5>
                <p class="text-muted small mb-0" id="mensagemExclusao"></p>
            </div>
            <div class="modal-footer border-0 bg-light d-flex justify-content-center py-3">
                <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" class="btn btn-danger btn-sm px-4 fw-bold shadow-sm" id="btnConfirmarExclusaoFinal">SIM, EXCLUIR DEFINITIVAMENTE</button>
            </div>
        </div>
    </div>
</div>

<form id="rejectForm" method="post" style="display: none;">{% csrf_token %}<input type="hidden" name="motivo" id="rejectMotivo"></form>

{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(function() {
    let dadosPreparados = {};
    let statusDisparos = {};
    let scIdAtual = null;
    let fornecedorEnviosMeta = {}; // armazena informações de envios anteriores por fornecedor

    // 1. LÓGICA DE AUDITORIA (RESTAURADA: FECHAR POPUPS AO CLICAR FORA)
    document.addEventListener('click', function(event) {
        const isClickInside = event.target.closest('.audit-container');
        if (!isClickInside) {
            document.querySelectorAll('.audit-popup.show').forEach(function(openPopup) {
                const collapseInstance = bootstrap.Collapse.getInstance(openPopup);
                if (collapseInstance) { collapseInstance.hide(); }
            });
        }
    });

    // 2. LÓGICA DE NAVEGAÇÃO DE TABS (RESTAURADA E CORRIGIDA)
    $('.summary-link').on('click', function(e) {
        e.preventDefault();
        $('.summary-link').removeClass('active');
        $(this).addClass('active');
        const target = $(this).attr('href');
        $('.tab-pane').removeClass('show active');
        $(target).addClass('show active');
    });

    // Manter aba ativa ao recarregar (Original restaurado)
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam) {
        const tabTrigger = document.querySelector(`.nav a[href="#${tabParam}"]`);
        if (tabTrigger) { 
            bootstrap.Tab.getOrCreateInstance(tabTrigger).show(); 
            $('.summary-link').removeClass('active');
            $(tabTrigger).addClass('active');
        }
    }

    // NOTE: old per-fornecedor inline removal warnings were removed to avoid conflicts
    // Selection blocking is now handled centrally in the select handler with a clear instruction.

    // Helper: Always show persistent warning when fornecedor with prior envios is selected
    function showPersistentFornecedorNotice(fId, fornecedorNome) {
        const meta = fornecedorEnviosMeta[fId];
        if (!meta || !meta.tem_envio_anterior) {
            $('#fornecedorSelectNotice').remove();
            $('#alertaBloqueioFornecedor').hide();
            // Desbloqueiar botão ENVIAR
            $('#btnEnviarCotacao').prop('disabled', false).removeClass('btn-danger').addClass('btn-success')
                                  .html('ENVIAR COTAÇÃO <i class="fas fa-paper-plane ms-1"></i>');
            return;
        }
        
        // BLOQUEIA o botão CONCLUIR e mostra alerta impeditivo
        $('#btnConcluirTudo').prop('disabled', true);
        $('#alertaBloqueioFornecedor').show();
        $('#btnEmergenciaFechar').show();
        
        // BLOQUEIA visualmente o botão ENVIAR
        $('#btnEnviarCotacao').prop('disabled', false) // não desabilita completamente para permitir validação no submit
                              .removeClass('btn-primary btn-success').addClass('btn-danger')
                              .html('<i class="fas fa-ban me-1"></i>AÇÃO BLOQUEADA');
        
        const itensEnviados = (meta.condicoes && Array.isArray(meta.condicoes.itens_enviados)) ? meta.condicoes.itens_enviados : (meta.itens_enviados || []);
        const countEnviados = itensEnviados.length;
        const totalItems = window.totalItems || Object.keys(window.itensMeta || {}).length;
        const nome = fornecedorNome || (meta.condicoes && meta.condicoes.fornecedor_nome) || meta.fornecedor_nome || `Fornecedor ${fId}`;
        
        // Build list of sent items
        const nomesList = itensEnviados.slice(0, 5).map(id => 
            (window.itensMeta && window.itensMeta[String(id)]) ? window.itensMeta[String(id)] : `Item ${id}`
        ).join('<br>');
        const moreNote = itensEnviados.length > 5 ? `<div class="small text-muted mt-1">... e mais ${itensEnviados.length - 5} itens</div>` : '';
        
        const noticeHtml = `
            <div id="fornecedorSelectNotice" class="alert alert-warning small mt-2" role="alert">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>⚠️ ${nome}</strong> já recebeu convite para <strong>${countEnviados}</strong> de <strong>${totalItems}</strong> item(s) desta solicitação.
                        <div class="small text-muted mt-2">
                            <strong>Para adicionar os itens restantes ou alterar prazo/forma de pagamento:</strong>
                            <ol class="mb-0 ps-3 mt-1">
                                <li>Vá para a aba <strong>"Em Cotação"</strong> desta página</li>
                                <li>Exclua o convite anterior desta SC em <strong>"Em Cotação"</strong></li>
                                <li>Volte para <strong>Convidar Fornecedores</strong>, selecione novamente o fornecedor, escolha os itens e defina novos prazos de entrega, pagamento e formas de pagamento (se for o caso)</li>
                            </ol>
                        </div>
                        ${countEnviados <= 10 ? `<details class="mt-2"><summary class="small text-primary" style="cursor:pointer;">Ver itens já enviados</summary><div class="small mt-1">${nomesList}${moreNote}</div></details>` : ''}
                    </div>
                    <div class="d-flex flex-column gap-1 ms-3">
                        <a href="?tab=aguardando" class="btn btn-sm btn-outline-primary" onclick="$('#solicitarCotacaoModal').modal('hide');" title="Ir para Em Cotação">Cotações</a>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="fornecedorSelectNoticeClose" title="Fechar aviso">Fechar</button>
                    </div>
                </div>
            </div>
        `;
        
        $('#fornecedorSelectNotice').remove();
        $('#fornecedorSelect').parent().append(noticeHtml);
        
        $('#fornecedorSelectNoticeClose').on('click', function() {
            $('#fornecedorSelectNotice').remove();
        });
    }

    // 3. CORREÇÃO SELECT2 (DROPDOWN PARENT FIX)
    // window.modoSingleFornecedor é definido quando o modal abre (true = SC já em cotação, false = iniciar nova)
    function initSelect2() {
        const isSingleMode = window.modoSingleFornecedor === true;
        const placeholder = isSingleMode ? "Pesquisar fornecedor (apenas 1)" : "Pesquisar fornecedores";
        
        const $sel = $('#fornecedorSelect');
        
        // Remove todos os handlers anteriores ANTES de destruir o Select2
        $sel.off('select2:select').off('select2:unselect').off('change');
        
        // Destrói o Select2 existente se houver
        if ($sel.hasClass("select2-hidden-accessible")) {
            $sel.select2('destroy');
        }
        
        // Limpa o valor atual
        $sel.val(null);
        
        // Configura o select com ou sem multiple baseado no modo
        if (isSingleMode) {
            $sel.removeAttr('multiple');
        } else {
            $sel.attr('multiple', 'multiple');
        }
        
        // Inicializa o Select2
        $sel.select2({ 
            placeholder: placeholder, 
            allowClear: true,
            dropdownParent: $('#solicitarCotacaoModal'),
            width: '100%',
            ajax: { 
                url: "{% url 'materiais:api_buscar_fornecedores' %}", 
                dataType: 'json', delay: 250,
                data: params => ({ term: params.term }),
                processResults: data => ({ results: data })
            } 
        });
        
        // Agora configura os handlers NA ORDEM CORRETA
        
        // 1. Handler para quando um fornecedor é removido (clicando no X da tag)
        $sel.on('select2:unselect', function(e) {
            // O Select2 já remove o valor, só precisamos atualizar a UI
            // Não precisa trigger('change') pois o Select2 já dispara automaticamente
        });
        
        // 2. Handler quando adiciona um fornecedor
        $sel.on('select2:select', function(e) {
            const fId = e.params.data.id;
            const sel = $(this);
            // enforce single selection ONLY in single mode (SC já em cotação)
            try {
                if (window.modoSingleFornecedor && !window._fornecedorReplaceInProgress) {
                    const vals = sel.val() || [];
                    if (Array.isArray(vals) && vals.length > 1) {
                        window._fornecedorReplaceInProgress = true;
                        sel.val([String(fId)]).trigger('change');
                        setTimeout(() => { window._fornecedorReplaceInProgress = false; }, 200);
                        showSmallToast('SC já em cotação: apenas 1 fornecedor por convite.');
                    }
                }
            } catch (err) {}
            // If we already have meta locally, check immediately
            const metaLocal = fornecedorEnviosMeta[fId];
            const notifyBlockedSelection = function(reasonMsg) {
                // Compute how many items would be blocked if current selection remains
                const selectedIds = sel.val() || [];
                const selectedCount = selectedIds.length;
                const nome = reasonMsg || fId;

                // build map itemId -> count of selected fornecedores that already have it
                const itemCounts = {};
                Object.keys(window.itensMeta || {}).forEach(itemId => { itemCounts[itemId] = 0; });
                selectedIds.forEach(sid => {
                    const meta = fornecedorEnviosMeta[sid] || {};
                    const itensEnv = (meta.condicoes && Array.isArray(meta.condicoes.itens_enviados) && meta.condicoes.itens_enviados) || meta.itens_enviados || [];
                    (itensEnv || []).forEach(iid => {
                        itemCounts[String(iid)] = (itemCounts[String(iid)] || 0) + 1;
                    });
                });

                const totalItems = window.totalItems || Object.keys(itemCounts).length;
                let blockedCount = 0;
                const blockedList = [];
                Object.keys(itemCounts).forEach(itemId => {
                    if (itemCounts[itemId] === selectedCount && selectedCount > 0) {
                        blockedCount += 1;
                        blockedList.push(itemId);
                    }
                });

                const significantThreshold = Math.ceil((totalItems || 1) * 0.5);

                // Create or update a persistent select-level notice explaining the situation
                try {
                    $('#fornecedorSelectNotice').remove();
                    const nomesList = blockedList.slice(0,5).map(id => (window.itensMeta && window.itensMeta[String(id)]) ? window.itensMeta[String(id)] : `Item ${id}` ).join('<br>');
                    const noticeHtml = `
                        <div id="fornecedorSelectNotice" class="alert alert-warning small mt-2" role="alert">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>Atenção — ${nome}:</strong> já recebeu ${blockedCount} de ${totalItems} item(s) desta solicitação.
                                    <div class="small text-muted mt-1">Para adicionar os itens restantes ou alterar prazo/forma de pagamento, remova o envio anterior no Histórico e convide o fornecedor novamente.</div>
                                    <div class="small mt-2">${nomesList}${blockedList.length > 5 ? '<div class="small text-muted">... e mais</div>' : ''}</div>
                                </div>
                                <div class="text-end">
                                    <a href="/editar-solicitacao/${scIdAtual}/" class="btn btn-sm btn-outline-primary mb-1" target="_blank">Abrir Histórico</a>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="fornecedorSelectNoticeClose">Fechar</button>
                                </div>
                            </div>
                        </div>
                    `;
                    sel.parent().append(noticeHtml);
                    $('#fornecedorSelectNoticeClose').on('click', function() { $('#fornecedorSelectNotice').remove(); });
                } catch(e) {}

                if (blockedCount > 0 && (blockedCount >= significantThreshold || blockedCount === totalItems)) {
                    // show modal summarizing impact and allow Cancel (remove) or Continue
                    const modalId = 'confirmFornecedorImpactModal';
                    // build item lines
                    const lines = blockedList.slice(0, 10).map(id => `<li>${window.itensMeta && window.itensMeta[String(id)] ? window.itensMeta[String(id)] : 'Item ' + id}</li>`).join('');
                    const moreNote = blockedList.length > 10 ? `<div class="small text-muted">... e mais ${blockedList.length - 10} itens</div>` : '';
                    const modalHtml = `
                        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Impacto ao adicionar fornecedor</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                              </div>
                              <div class="modal-body">
                                <p>Ao adicionar <strong>${nome}</strong>, <strong>${blockedCount}/${totalItems}</strong> itens ficarão bloqueados (não poderão ser selecionados) porque todos os fornecedores selecionados já os receberam.</p>
                                <ul class="small">${lines}</ul>
                                ${moreNote}
                                <p class="small text-muted">Você pode remover o fornecedor adicionado se preferir selecionar somente os itens pendentes.</p>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary btn-sm" id="modalCancelRemoveFornecedor">Remover fornecedor</button>
                                <button type="button" class="btn btn-primary btn-sm" id="modalContinueAddFornecedor">Continuar mesmo assim</button>
                              </div>
                            </div>
                          </div>
                        </div>
                    `;

                    // ensure only one modal exists
                    $('#' + modalId).remove();
                    $('body').append(modalHtml);
                    const modalEl = document.getElementById(modalId);
                    const bsModal = new bootstrap.Modal(modalEl);
                    bsModal.show();

                    $('#modalCancelRemoveFornecedor').on('click', function() {
                        // remove the newly added fornecedor from selection
                        const vals = sel.val() || [];
                        const novos = (vals || []).filter(v => String(v) !== String(fId));
                        sel.val(novos).trigger('change');
                        bsModal.hide();
                        setTimeout(() => $('#' + modalId).remove(), 300);
                    });

                    $('#modalContinueAddFornecedor').on('click', function() {
                        bsModal.hide();
                        setTimeout(() => $('#' + modalId).remove(), 300);
                    });
                } else if (blockedCount > 0) {
                                        // light toast informing partial blocks
                                        showSmallToast(`${nome} já possui ${blockedCount} item(s) previamente enviados. Apenas os itens pendentes serão enviados.`);
                                        // Additionally, if this is a partial envio (some items remain), show a short instruction modal explaining how to add more items
                                        const remaining = totalItems - blockedCount;
                                        if (remaining > 0) {
                                                const instrId = 'instrucaoReconviteModal';
                                                const instrHtml = `
                                                        <div class="modal fade" id="${instrId}" tabindex="-1" aria-hidden="true">
                                                            <div class="modal-dialog modal-dialog-centered">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title">Como adicionar itens restantes a ${nome}</h5>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                                                    </div>
                                                                    <div class="modal-body small">
                                                                        <p>Este fornecedor já possui envios para parte dos itens. Para adicionar os itens restantes sem conflito, siga estes passos:</p>
                                                                        <ol>
                                                                            <li>Acesse o <strong>Histórico</strong> da Solicitação e localize o envio existente para <strong>${nome}</strong>.</li>
                                                                            <li>Remova ou cancele o envio anterior (se você tiver permissão) para que o fornecedor fique elegível a novo convite.</li>
                                                                            <li>Volte para <strong>Convidar Fornecedores</strong>, selecione o fornecedor novamente e marque apenas os itens que faltam.</li>
                                                                        </ol>
                                                                        <p class="text-muted">Se preferir não remover o envio anterior, você pode convidar outro fornecedor para os itens restantes.</p>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                `;
                                                $('#' + instrId).remove();
                                                $('body').append(instrHtml);
                                                const mEl = document.getElementById(instrId);
                                                if (mEl) new bootstrap.Modal(mEl).show();
                                        }
                } else {
                    // minimal toast: fornecedor possui envios mas sem bloqueios
                    showSmallToast(`${nome} possui envios anteriores, mas não bloqueia itens selecionáveis.`);
                }
            };

            if (metaLocal) {
                // Let the change handler deal with showing notices
                return;
            }

            // Otherwise request server to check single fornecedor
            fetch(`/api/verificar-envios-anteriores/${scIdAtual}/?fornecedor_id=${fId}`)
                .then(res => res.json())
                .then(data => {
                    fornecedorEnviosMeta[fId] = data;
                    // Let the change handler show the notice
                })
                .catch(() => {
                    // ignore errors — allow selection if check fails
                });
        });

        // Detecta mudança na seleção de fornecedores e carrega meta de envios anteriores
        $('#fornecedorSelect').on('change', function() {
            const fornecedoresSelecionadosVal = $(this).val();
            const fornecedoresSelecionados = Array.isArray(fornecedoresSelecionadosVal) ? fornecedoresSelecionadosVal : (fornecedoresSelecionadosVal ? [fornecedoresSelecionadosVal] : []);

            // Remove any previous select-level notice (we'll re-create below if needed)
            $('#fornecedorSelectNotice').remove();
            
            // SEMPRE restaura botão ao estado normal ANTES de verificar novo fornecedor
            $('#alertaBloqueioFornecedor').hide();
            $('#btnEmergenciaFechar').hide();
            $('#btnEnviarCotacao').prop('disabled', false).removeClass('btn-danger').addClass('btn-success')
                                  .html('ENVIAR COTAÇÃO <i class="fas fa-paper-plane ms-1"></i>');

            // Recalcula se os campos de negociação devem ser bloqueados
            checkNegotiationFieldsState();

            // Atualiza contador
            const count = fornecedoresSelecionados ? fornecedoresSelecionados.length : 0;
            $('#fornecedorCounter').text(count === 0 ? 'Nenhum fornecedor selecionado' : 
                                        `${count} fornecedor${count > 1 ? 'es' : ''} selecionado${count > 1 ? 's' : ''}`);
            // NÃO mostra botão remover automaticamente - ele só aparece quando houver duplicação
            // Força ocultar sempre
            $('#btnRemoveSelectedFornecedor').addClass('d-none');

            // Atualiza bloqueio de itens mesmo quando vazio
            if (!fornecedoresSelecionados || fornecedoresSelecionados.length === 0) {
                updateItemSelectionDisabled();
                return;
            }

            // Para cada fornecedor, busca meta de envios anteriores e atualiza o mapa
            fornecedoresSelecionados.forEach(fId => {
                fetch(`/api/verificar-envios-anteriores/${scIdAtual}/?fornecedor_id=${fId}`)
                    .then(res => res.json())
                    .then(data => {
                        fornecedorEnviosMeta[fId] = data;
                        // se houver envios anteriores, mostra aviso persistente
                        if (data && data.tem_envio_anterior) {
                            const nome = data.fornecedor_nome || (data.condicoes && data.condicoes.fornecedor_nome) || null;
                            showPersistentFornecedorNotice(fId, nome);
                        }
                        // atualiza UI (desabilita itens conforme necessário)
                        updateItemSelectionDisabled();
                        // Atualiza estado dos campos de negociação (prazo/forma/prazo dias)
                        checkNegotiationFieldsState();
                    })
                    .catch(() => {
                        // garante que não trave a UI
                        fornecedorEnviosMeta[fId] = { success: false };
                        updateItemSelectionDisabled();
                    });
            });
            
        });
    }

    // Handler do botão remover (clear selection) - configurado globalmente
    $(document).on('click', '#btnRemoveSelectedFornecedor', function() {
        const sel = $('#fornecedorSelect');
        sel.val(null).trigger('change');
        // Oculta o próprio botão
        $(this).addClass('d-none');
        // Restaura avisos
        $('#fornecedorSelectNotice').remove();
        showSmallToast('Fornecedor removido. Você pode selecionar outro.');
    });

    function setNegotiationFieldsDisabled(disabled, message) {
        const $prazoResp = $('input[name="prazo_resposta"]');
        const $forma = $('select[name="forma_pagamento"]');
        const $prazoPag = $('input[name="prazo_pagamento"]');

        $prazoResp.prop('disabled', disabled);
        $forma.prop('disabled', disabled);
        $prazoPag.prop('disabled', disabled);

        const $notice = $('#negociacaoBlockedNotice');
        if (disabled) {
            $notice.html(message).removeClass('d-none');
        } else {
            $notice.addClass('d-none').text('');
        }
    }

    function checkNegotiationFieldsState() {
        const selVal = $('#fornecedorSelect').val();
        const sel = Array.isArray(selVal) ? selVal : (selVal ? [selVal] : []);
        let blockedFornecedores = [];
        sel.forEach(fId => {
            const meta = fornecedorEnviosMeta[fId];
            if (meta && meta.tem_envio_anterior) {
                const nome = meta.fornecedor_nome || (meta.condicoes && meta.condicoes.fornecedor_nome) || fId;
                blockedFornecedores.push(nome);
            }
        });
        if (blockedFornecedores.length > 0) {
            const names = blockedFornecedores.join(', ');
            setNegotiationFieldsDisabled(true, `<strong>Atenção:</strong> As condições não podem ser alteradas enquanto o(s) fornecedor(es) <strong>${names}</strong> já estiver(em) em cotação para esta SC. Remova-os para desbloquear.`);
        } else {
            setNegotiationFieldsDisabled(false, '');
        }
    }

    const solicitarCotacaoModal = document.getElementById('solicitarCotacaoModal');
    solicitarCotacaoModal.addEventListener('show.bs.modal', function(event) {
        // Proteção contra relatedTarget nulo
        if (!event.relatedTarget) {
            console.warn('Modal aberto sem relatedTarget');
            return;
        }
        
        scIdAtual = event.relatedTarget.getAttribute('data-sc-id');
        const scName = event.relatedTarget.getAttribute('data-sc-name');
        $('#sc_name_display').text(scName || '');
        $('#prazo_pagamento_input').val('');
        
        // Define data máxima no campo prazo de resposta baseado na data necessária da SC
        // Busca a data necessária do elemento na lista de SCs
        const scCard = $(event.relatedTarget).closest('.card, .border');
        const dataNecessariaText = scCard.find('strong:contains("Necessário:")').parent().text();
        const match = dataNecessariaText.match(/\d{2}\/\d{2}\/\d{4}/);
        if (match) {
            const dataParts = match[0].split('/');
            const dataISO = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`;
            $('input[name="prazo_resposta"]').attr('max', dataISO);
        }
        
        // Busca data necessária da SC e define como data máxima no prazo de resposta
        fetch(`/api/solicitacao-meta/${scIdAtual}/`).then(res => res.json()).then(meta => {
            if (meta.data_necessidade) {
                $('input[name="prazo_resposta"]').attr('max', meta.data_necessidade);
            }
        }).catch(() => {});
        
        // DETECTA DE QUAL ABA O MODAL FOI ABERTO
        // Se veio da aba "Em Cotação" (aguardando), ativa modo single fornecedor
        // Se veio de "Para Iniciar", permite múltiplos fornecedores
        const clickedButton = event.relatedTarget;
        const parentTab = $(clickedButton).closest('.tab-pane').attr('id') || 'iniciar-cotacao';
        window.modoSingleFornecedor = (parentTab === 'aguardando'); // true se em cotação, false se para iniciar
        
        // Reset do fornecedorEnviosMeta para nova sessão
        fornecedorEnviosMeta = {};
        
        // Inicializa o Select2 (a função já cuida da destruição se necessário)
        initSelect2();

        fetch(`/api/solicitacao-itens/${scIdAtual}/`).then(res => res.json()).then(data => {
            const listDiv = $('#itensParaCotacaoList');
            if (data.success) {
                const temItensEnviados = data.itens.some(item => item.ja_enviado);
                let html = '';
                
                // Alerta se houver itens já enviados
                if (temItensEnviados) {
                    html += `<div class="alert alert-info py-2 px-3 mb-2 small">
                        <i class="fas fa-info-circle me-1"></i><strong>Atenção:</strong> Alguns itens já foram enviados anteriormente. 
                        Itens marcados em <span class="badge bg-success">VERDE</span> já estão em cotação.
                    </div>`;
                }
                
                html += '<div class="list-group list-group-flush small shadow-sm border rounded">';
                data.itens.forEach(item => {
                    const jaEnviadoClass = item.ja_enviado ? 'bg-success-subtle border-success' : '';
                    const jaEnviadoBadge = item.ja_enviado ? `<span class="badge bg-success ms-2" style="font-size:0.6rem">JÁ ENVIADO</span> <button type="button" class="btn btn-sm btn-outline-secondary btn-item-sent-list ms-2 p-0" style="width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:4px;" aria-label="Mostra fornecedores que receberam este item" data-item-id="${item.id}" data-enviado="${encodeURIComponent(JSON.stringify(item.enviado_por || []))}" data-bs-toggle="popover" data-bs-trigger="focus" title="Fornecedores"><i class="fas fa-caret-down" style="font-size:0.8rem"></i></button>` : '';
                    const checked = item.ja_enviado ? '' : 'checked';  // Por padrão, marcar apenas os não enviados
                    html += `<label class="list-group-item d-flex align-items-start ${jaEnviadoClass} item-row" data-item-id="${item.id}">
                        <input class="form-check-input me-3 item-checkbox" type="checkbox" name="itens_cotacao" value="${item.id}" ${checked}>
                        <div class="flex-grow-1">
                            <div class="text-dark fw-bold">${item.descricao}${jaEnviadoBadge}</div>
                            <div class="text-muted" style="font-size:0.7rem">${item.quantidade} ${item.unidade}</div>
                            <div class="form-text small text-warning item-legend d-none" data-item-id="${item.id}"></div>
                        </div>
                    </label>`;
                });
                listDiv.html(html + '</div>');

                // Guarda mapa itemId -> descrição para uso em popovers por fornecedor
                window.itensMeta = window.itensMeta || {};
                window.totalItems = Array.isArray(data.itens) ? data.itens.length : 0;
                if (Array.isArray(data.itens)) {
                    data.itens.forEach(it => {
                        try {
                            window.itensMeta[String(it.id)] = `${it.quantidade} ${it.unidade} de ${it.descricao}`;
                        } catch(e) {}
                    });
                }

                // Inicializa popovers com dados de quem já recebeu cada item
                document.querySelectorAll('.btn-item-sent-list').forEach(el => {
                    try {
                        const raw = el.getAttribute('data-enviado') || '';
                        let arr = [];
                        try { arr = raw ? JSON.parse(decodeURIComponent(raw)) : []; } catch(e) { arr = []; }
                        const content = arr && arr.length ? `<ul class="mb-0"><li>${arr.join('</li><li>')}</li></ul>` : '<div class="small text-muted">Nenhum envio registrado para este item.</div>';
                        new bootstrap.Popover(el, { html: true, content: content, placement: 'auto' });
                    } catch(e) {}
                });

                // Atualiza bloqueios de seleção após montar a lista de itens
                updateItemSelectionDisabled();
            }
        });
    });

    // Atualiza a disponibilidade dos checkboxes de itens conforme fornecedores selecionados
    function updateItemSelectionDisabled() {
        const selecionadosVal = $('#fornecedorSelect').val();
        const selecionados = Array.isArray(selecionadosVal) ? selecionadosVal : (selecionadosVal ? [selecionadosVal] : []);
        // Mapeia itemId -> [fornecedor nomes] apenas para fornecedores selecionados
        const bloqueios = {};
        const selectedCount = (selecionados && selecionados.length) ? selecionados.length : 0;

        selecionados.forEach(fId => {
            const meta = fornecedorEnviosMeta[fId];
            if (meta && meta.success && meta.tem_envio_anterior && meta.condicoes && meta.condicoes.itens_enviados) {
                (meta.condicoes.itens_enviados || []).forEach(itemId => {
                    bloqueios[String(itemId)] = bloqueios[String(itemId)] || [];
                    bloqueios[String(itemId)].push(meta.fornecedor_nome || (meta.condicoes && meta.condicoes.fornecedor_nome) || fId);
                });
            }
        });

        // Aplica bloqueios na UI: bloqueia o checkbox somente se TODOS os fornecedores selecionados
        // já tiveram esse item enviado. Se alguns fornecedores ainda não receberam, permite seleção.
        $('.item-checkbox').each(function() {
            const $cb = $(this);
            const id = String($cb.val());
            const $label = $cb.closest('label');
            const $legend = $label.find('.item-legend');

            const nomesQueTem = bloqueios[id] || [];
            const haveCount = nomesQueTem.length;

            if (selectedCount > 0 && haveCount === selectedCount) {
                // todos os fornecedores selecionados já receberam este item -> bloquear
                $cb.prop('checked', false).prop('disabled', true);
                $label.addClass('bg-warning-subtle border-warning');
                const nomes = nomesQueTem.join(', ');
                $legend.removeClass('d-none').text(`Bloqueado: todos os fornecedores selecionados já receberam este item (${nomes}). Para enviar, remova o envio anterior ou escolha fornecedores diferentes.`);
            } else {
                // há pelo menos um fornecedor selecionado que ainda NÃO recebeu -> permitir
                $cb.prop('disabled', false);
                $label.removeClass('bg-warning-subtle border-warning');
                if (haveCount > 0) {
                    $legend.removeClass('d-none').text(`Já enviado para: ${nomesQueTem.join(', ')}. Ainda é possível selecionar este item.`);
                } else {
                    $legend.addClass('d-none').text('');
                }
            }
        });

        // Atualiza popovers para os botões que mostram fornecedores que receberam este item
        // Remove instâncias antigas
        document.querySelectorAll('.btn-item-sent-list').forEach(el => {
            const inst = bootstrap.Popover.getInstance(el);
            if (inst) inst.dispose();
        });

        document.querySelectorAll('.btn-item-sent-list').forEach(el => {
            try {
                const raw = el.getAttribute('data-enviado');
                let arr = [];
                if (raw) {
                    try { arr = JSON.parse(decodeURIComponent(raw)); } catch(e) { arr = []; }
                }
                const itemId = String(el.getAttribute('data-item-id'));
                const nomesFallback = bloqueios[itemId] || [];
                const nomes = (arr && arr.length) ? arr : nomesFallback;
                const content = nomes && nomes.length ? `<ul class="mb-0"><li>${nomes.join('</li><li>')}</li></ul>` : '<div class="small text-muted">Nenhum envio registrado para este item.</div>';
                new bootstrap.Popover(el, { html: true, content: content, placement: 'auto' });
            } catch(e) {}
        });
    }

    // 4. TRANSIÇÃO PARA MODAL 2 E DISPARO COM CONTINGÊNCIA
    $('#formPrepararCotacao').on('submit', function(e) {
        e.preventDefault();
        const fSelect = $('#fornecedorSelect').select2('data');
        if (fSelect.length === 0) return alert("Selecione ao menos um fornecedor.");

        // VALIDAÇÃO IMPEDITIVA: Bloquear se fornecedor selecionado tem envios anteriores
        const fornecedorSelecionadoId = fSelect[0].id;
        const metaFornecedor = fornecedorEnviosMeta[fornecedorSelecionadoId];
        
        if (metaFornecedor && metaFornecedor.tem_envio_anterior) {
            const nomeFornecedor = fSelect[0].text;
            
            // Abre modal estilizado em vez de alert
            $('#nomeFornecedorBloqueado').text(nomeFornecedor);
            const modalBloqueio = new bootstrap.Modal(document.getElementById('modalAcaoBloqueada'));
            modalBloqueio.show();
            
            // Handler do botão remover fornecedor
            $('#btnRemoverFornecedorBloqueado').off('click').on('click', function() {
                // Remove o fornecedor da seleção
                $('#fornecedorSelect').val(null).trigger('change');
                // Fecha o modal
                modalBloqueio.hide();
                // Scroll até o select para o usuário ver que foi limpo
                $('#fornecedorSelect').parent()[0]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            
            return;
        }

        // Validação: verificar se há pelo menos um item selecionado
        const itensSelecionados = $('input[name="itens_cotacao"]:checked');
        if (itensSelecionados.length === 0) {
            alert("Selecione pelo menos um item para enviar aos fornecedores.");
            return;
        }

        dadosPreparados = {
            sc_id: scIdAtual,
            prazo_resposta: $('input[name="prazo_resposta"]').val(),
            forma_pagamento: $('select[name="forma_pagamento"]').val(),
            prazo_pagamento: $('input[name="prazo_pagamento"]').val(),
            observacoes: $('textarea[name="observacoes"]').val(),
            itens: $('input[name="itens_cotacao"]:checked').map(function() { return $(this).val(); }).get(),
            fornecedores: fSelect.map(f => ({ id: f.id, nome: f.text }))
        };

        $('#listaDisparoFornecedores').empty();
        statusDisparos = {};
        dadosPreparados.fornecedores.forEach(f => {
            statusDisparos[f.id] = false;
            // calcula quantos itens já foram enviados para este fornecedor, se tivermos meta
            let enviadosCount = 0;
            const metaF = fornecedorEnviosMeta[f.id] || {};
            const enviadosIds = (metaF.condicoes && Array.isArray(metaF.condicoes.itens_enviados) && metaF.condicoes.itens_enviados) || metaF.itens_enviados || [];
            enviadosCount = enviadosIds.length || 0;
            // Cria botão compacto para mostrar quais itens já foram enviados
            const itensBtnHtml = enviadosCount > 0 ? ` <button type="button" class="btn btn-sm btn-outline-secondary btn-fornecedor-sent-list p-0 ms-2" data-enviados="${encodeURIComponent(JSON.stringify(enviadosIds))}" aria-label="Itens já enviados"><i class="fas fa-info-circle" style="font-size:0.85rem"></i></button>` : '';
            const badgeHtml = enviadosCount > 0 ? `<small class="text-muted"> - <span class="badge bg-light text-dark">${enviadosCount} já enviados</span>${itensBtnHtml}</small>` : '';

            $('#listaDisparoFornecedores').append(`
                <div class="list-group-item disparo-item p-3 d-flex justify-content-between align-items-center" id="row-f-${f.id}">
                    <div><span class="d-block small fw-bold text-dark text-uppercase">${f.nome} ${badgeHtml}</span><span class="badge bg-secondary-subtle text-secondary fw-normal" id="status-f-${f.id}" style="font-size:0.65rem">PENDENTE</span></div>
                    <div class="btn-group" id="actions-f-${f.id}">
                        <button type="button" class="btn btn-xs btn-outline-primary" onclick="dispararIndividual('${f.id}', 'auto')">AUTO</button>
                        <button type="button" class="btn btn-xs btn-outline-dark" onclick="dispararIndividual('${f.id}', 'manual')">MANUAL</button>
                    </div>
                </div>
            `);
        });

        // Inicializa popovers por fornecedor (lista de itens já enviados usando itensMeta)
        document.querySelectorAll('.btn-fornecedor-sent-list').forEach(el => {
            try {
                const raw = el.getAttribute('data-enviados') || '';
                let arr = [];
                try { arr = raw ? JSON.parse(decodeURIComponent(raw)) : []; } catch(e) { arr = []; }
                const lines = (arr && arr.length) ? arr.map(id => window.itensMeta && window.itensMeta[String(id)] ? window.itensMeta[String(id)] : `Item ${id}`) : [];
                const content = lines.length ? `<ul class="mb-0"><li>${lines.join('</li><li>')}</li></ul>` : '<div class="small text-muted">Nenhum item registrado.</div>';
                new bootstrap.Popover(el, { html: true, content: content, placement: 'auto' });
            } catch(e) {}
        });

        // Se algum fornecedor tem todos os itens já enviados, mostra instrução para remover
        const hasFullyBlocked = dadosPreparados.fornecedores.some(f => {
            const meta = fornecedorEnviosMeta[f.id];
            return meta && meta.condicoes && Array.isArray(meta.condicoes.itens_enviados) && meta.condicoes.itens_enviados.length >= dadosPreparados.itens.length;
        });
        if (hasFullyBlocked) {
            $('#fornecedorBlockingNotice').removeClass('d-none');
        } else {
            $('#fornecedorBlockingNotice').addClass('d-none');
        }

        $('#solicitarCotacaoModal').modal('hide');
        $('#modalDisparoIndividual').modal('show');
    });

    window.dispararIndividual = function(fId, tipo) {
        const btnGroup = $(`#actions-f-${fId}`);
        const rowStatus = $(`#status-f-${fId}`);
        const rowElement = $(`#row-f-${fId}`);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);

        // Busca o nome do fornecedor
        const fornecedorNome = dadosPreparados.fornecedores.find(f => f.id == fId)?.nome || 'Fornecedor';
        
        // Mostra feedback visual de "enviando"
        rowStatus.removeClass('bg-secondary-subtle text-secondary bg-danger-subtle text-danger bg-warning-subtle text-warning')
                 .addClass('bg-info-subtle text-info')
                 .html('<span class="spinner-border spinner-border-sm me-1"></span>ENVIANDO...');
        btnGroup.html('<span class="spinner-border spinner-border-sm text-primary"></span>');

        // Prepara lista de itens excluindo os que já foram enviados para este fornecedor
        const enviadosMeta = fornecedorEnviosMeta[fId] && fornecedorEnviosMeta[fId].condicoes && fornecedorEnviosMeta[fId].condicoes.itens_enviados ? fornecedorEnviosMeta[fId].condicoes.itens_enviados.map(i => String(i)) : [];
        const itensParaEnviar = dadosPreparados.itens.filter(id => !enviadosMeta.includes(String(id)));

        // Se não houver nenhum item novo para enviar, bloqueia e avisa
        if (itensParaEnviar.length === 0) {
            statusDisparos[fId] = false;
            rowStatus.removeClass('bg-info-subtle text-info')
                     .addClass('bg-warning-subtle text-warning')
                     .html('<i class="fas fa-ban me-1"></i>BLOQUEADO');
            btnGroup.html('<span class="text-danger small"><i class="fas fa-ban me-1"></i>Sem itens novos</span>');
            alert(`Todos os itens selecionados já foram enviados para ${fornecedorNome}. Não é possível reenviar com condições diferentes.`);
            return;
        }

        const fd = new FormData();
        fd.append('fornecedor', fId); 
        fd.append('tipo_envio', tipo);
        fd.append('forma_pagamento', dadosPreparados.forma_pagamento);
        fd.append('prazo_pagamento', dadosPreparados.prazo_pagamento);
        fd.append('observacoes', dadosPreparados.observacoes);
        if (dadosPreparados.prazo_resposta) fd.append('prazo_resposta', dadosPreparados.prazo_resposta);
        itensParaEnviar.forEach(id => fd.append('itens_cotacao', id));
        fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/solicitacao/${dadosPreparados.sc_id}/enviar-cotacao/`, { method: 'POST', body: fd, signal: controller.signal })
        .then(res => { clearTimeout(timeoutId); return res.json(); })
        .then(data => {
            if (data.success) {
                statusDisparos[fId] = true;
                rowElement.addClass('ready');
                
                if (tipo === 'auto') {
                    rowStatus.removeClass('bg-info-subtle text-info')
                             .addClass('bg-success-subtle text-success')
                             .html('<i class="fas fa-check-circle me-1"></i>ENVIADO AUTO');
                    btnGroup.html('<i class="fas fa-check text-success fa-lg"></i>');
                } else {
                    rowStatus.removeClass('bg-info-subtle text-info')
                             .addClass('bg-primary-subtle text-primary')
                             .html('<i class="fas fa-clipboard-check me-1"></i>TEXTO GERADO');
                    btnGroup.html('<i class="fas fa-check text-primary fa-lg"></i>');
                    window.open(data.url_confirmacao, '_blank');
                }
                
                if (Object.values(statusDisparos).every(s => s === true)) {
                    // Só habilita se não houver fornecedor com envios anteriores selecionado
                    const fornecedorSel = $('#fornecedorSelect').val();
                    const temBloqueio = fornecedorSel && fornecedorEnviosMeta[fornecedorSel] && fornecedorEnviosMeta[fornecedorSel].tem_envio_anterior;
                    if (!temBloqueio) {
                        $('#btnConcluirTudo').prop('disabled', false);
                    }
                }
            } else { 
                throw new Error(data.message); 
            }
        })
        .catch(err => {
            clearTimeout(timeoutId);
            statusDisparos[fId] = false;
            
            if (err.name === 'AbortError') {
                rowStatus.removeClass('bg-info-subtle text-info')
                         .addClass('bg-danger-subtle text-danger')
                         .html('<i class="fas fa-exclamation-triangle me-1"></i>TIMEOUT');
                btnGroup.html(`
                    <button type="button" class="btn btn-xs btn-warning" onclick="dispararIndividual('${fId}', 'manual')" title="Falha ao enviar automaticamente. Envie manualmente.">
                        <i class="fas fa-hand-paper me-1"></i>MANUAL
                    </button>
                `);
            } else if (err.message && err.message.includes('BLOQUEIO')) {
                rowStatus.removeClass('bg-info-subtle text-info')
                         .addClass('bg-warning-subtle text-warning')
                         .html('<i class="fas fa-ban me-1"></i>BLOQUEADO');
                alert(err.message);
                btnGroup.html('<span class="text-danger small"><i class="fas fa-ban me-1"></i>Bloqueado</span>');
            } else {
                rowStatus.removeClass('bg-info-subtle text-info')
                         .addClass('bg-danger-subtle text-danger')
                         .html('<i class="fas fa-times-circle me-1"></i>ERRO');
                btnGroup.html(`
                    <button type="button" class="btn btn-xs btn-warning" onclick="dispararIndividual('${fId}', 'manual')" title="Erro ao enviar. Tente envio manual.">
                        <i class="fas fa-hand-paper me-1"></i>MANUAL
                    </button>
                `);
            }
        });
    };

    // Small toast helper (top-right)
    function showSmallToast(message) {
        const id = `smallToast_${Date.now()}`;
        const toastHtml = `
            <div id="${id}" class="toast align-items-center text-dark bg-light border" role="alert" aria-live="polite" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body small">${message}</div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
                </div>
            </div>
        `;
        if ($('#smallToastContainer').length === 0) {
            $('body').append('<div id="smallToastContainer" style="position:fixed; right:20px; top:20px; z-index:2000;"></div>');
        }
        $('#smallToastContainer').append(toastHtml);
        const el = document.getElementById(id);
        const bs = new bootstrap.Toast(el, { delay: 6000 });
        bs.show();
        el.addEventListener('hidden.bs.toast', () => { $(el).remove(); });
    }

    // Remove fornecedores que estão bloqueando todos os itens (chamado pelo botão no aviso)
    $(document).on('click', '#btnRemoveBlockedFornecedores', function() {
        if (!window.dadosPreparados || !Array.isArray(window.dadosPreparados.fornecedores)) return;

        const fornecedoresAntes = window.dadosPreparados.fornecedores;
        const bloqueados = fornecedoresAntes.filter(f => {
            const meta = fornecedorEnviosMeta[f.id];
            return meta && meta.condicoes && Array.isArray(meta.condicoes.itens_enviados) && meta.condicoes.itens_enviados.length >= (window.dadosPreparados.itens || []).length;
        }).map(f => String(f.id));

        if (bloqueados.length === 0) {
            const tmp = $('<div class="alert alert-info small m-3">Nenhum fornecedor bloqueado encontrado.</div>');
            $('#modalDisparoIndividual .modal-body').prepend(tmp);
            setTimeout(() => tmp.fadeOut(300, () => tmp.remove()), 3000);
            return;
        }

        // Remove visualmente as linhas e as entradas de status
        // Guarda HTML das linhas removidas para possível desfazer
        const removedRowsHtml = {};
        bloqueados.forEach(id => {
            const $r = $(`#row-f-${id}`);
            if ($r.length) removedRowsHtml[id] = $r.prop('outerHTML');
            $r.slideUp(200, function() { $(this).remove(); });
            if (statusDisparos[id] !== undefined) delete statusDisparos[id];
            // também limpa meta local para evitar reaparecer
            if (fornecedorEnviosMeta[id]) delete fornecedorEnviosMeta[id];
        });

        // Atualiza o array de fornecedores preparados
        window.dadosPreparados.fornecedores = fornecedoresAntes.filter(f => !bloqueados.includes(String(f.id)));

        // Se houver seletor Select2 no modal anterior, remove também as seleções
        const sel = $('#fornecedorSelect');
        if (sel.length && sel.hasClass('select2-hidden-accessible')) {
            const vals = sel.val() || [];
            const novos = (vals || []).filter(v => !bloqueados.includes(String(v)));
            sel.val(novos).trigger('change');
        }

        // Mensagem de feedback
        const aviso = $(`<div class="alert alert-success small m-3">Removido ${bloqueados.length} fornecedor(es) bloqueado(s).</div>`);
        $('#modalDisparoIndividual .modal-body').prepend(aviso);
        setTimeout(() => aviso.fadeOut(300, () => aviso.remove()), 3500);

        // Chama API para registrar no histórico
        let removedFornecedoresPayload = fornecedoresAntes.filter(f => bloqueados.includes(String(f.id))).map(f => ({ id: f.id, nome: f.nome }));
        try {
            const payload = { fornecedores: removedFornecedoresPayload };
            fetch(`/solicitacao/${window.dadosPreparados.sc_id}/registrar-remocao-bloqueados/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(j => {
                if (!j.success) console.warn('Histórico não registrado:', j.message);
            }).catch(e => console.warn('Erro ao registrar histórico:', e));
        } catch(e) { console.warn('Erro ao montar payload de histórico', e); }

        // Cria toast de confirmação com Undo
        const toastId = `toastUndo_${Date.now()}`;
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="polite" aria-atomic="true" data-bs-delay="10000">
                <div class="d-flex">
                    <div class="toast-body small">${bloqueados.length} fornecedor(es) bloqueado(s) removido(s). Ação registrada no histórico.</div>
                    <button type="button" class="btn btn-sm btn-link text-white me-2" id="${toastId}_undo">Desfazer</button>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
                </div>
            </div>
        `;
        const $container = $('#toastContainer');
        if ($container.length === 0) {
            $('body').append('<div id="toastContainer" style="position:fixed; right:20px; bottom:20px; z-index:2000;"></div>');
        }
        $(`#toastContainer`).append(toastHtml);
        const toastEl = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastEl);
        bsToast.show();

        // Recalcula o estado dos campos de negociação após remoção
        checkNegotiationFieldsState();

        // Handler do Undo
        $(`#${toastId}_undo`).on('click', function() {
            // Reinsere fornecedores nos dados preparados e UI
            removedFornecedoresPayload.forEach(f => {
                // evita duplicados
                if (!window.dadosPreparados.fornecedores.some(x => String(x.id) === String(f.id))) {
                    window.dadosPreparados.fornecedores.push({ id: f.id, nome: f.nome });
                    // re-insere linha HTML se tínhamos guardado
                    if (removedRowsHtml[String(f.id)]) {
                        $('#listaDisparoFornecedores').append(removedRowsHtml[String(f.id)]);
                    } else {
                        // fallback simples
                        $('#listaDisparoFornecedores').append(`<div class="list-group-item disparo-item p-3 d-flex justify-content-between align-items-center" id="row-f-${f.id}"><div><span class="d-block small fw-bold text-dark text-uppercase">${f.nome}</span><span class="badge bg-secondary-subtle text-secondary fw-normal" id="status-f-${f.id}" style="font-size:0.65rem">PENDENTE</span></div><div class="btn-group" id="actions-f-${f.id}"><button type="button" class="btn btn-xs btn-outline-primary" onclick="dispararIndividual('${f.id}', 'auto')">AUTO</button><button type="button" class="btn btn-xs btn-outline-dark" onclick="dispararIndividual('${f.id}', 'manual')">MANUAL</button></div></div>`);
                    }
                }
            });

            // atualiza select2 se existir
            const sel = $('#fornecedorSelect');
            if (sel.length && sel.hasClass('select2-hidden-accessible')) {
                const vals = sel.val() || [];
                const novos = Array.from(new Set(vals.concat(removedFornecedoresPayload.map(f => String(f.id)))));
                sel.val(novos).trigger('change');
            }

            // registra desfazer no histórico via API
            try {
                fetch(`/solicitacao/${window.dadosPreparados.sc_id}/registrar-desfazer-remocao-bloqueados/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ fornecedores: removedFornecedoresPayload })
                }).then(r => r.json()).then(j => {
                    if (!j.success) console.warn('Desfazer não registrado:', j.message);
                }).catch(e => console.warn('Erro ao registrar desfazer:', e));
            } catch(e) { console.warn('Erro ao montar payload desfazer', e); }

            // Recalcula estado (pode voltar a bloquear campos se estes fornecedores tinham envios anteriores)
            checkNegotiationFieldsState();
            bsToast.hide();
        });

        // remove toast do DOM após escondido
        toastEl.addEventListener('hidden.bs.toast', function () { $(toastEl).remove(); });

        // Atualiza visibilidade do card de bloqueio
        const hasFullyBlocked = window.dadosPreparados.fornecedores.some(f => {
            const meta = fornecedorEnviosMeta[f.id];
            return meta && meta.condicoes && Array.isArray(meta.condicoes.itens_enviados) && meta.condicoes.itens_enviados.length >= (window.dadosPreparados.itens || []).length;
        });
        if (!hasFullyBlocked) $('#fornecedorBlockingNotice').addClass('d-none');
    });

    $('#btnConcluirTudo').click(() => location.reload());
    
    // Botão de emergência para sair de situações bloqueadas
    $('#btnEmergenciaFechar').click(function() {
        if (confirm('⚠️ ATENÇÃO: Você está prestes a sair sem concluir os envios.\n\nTodos os convites NÃO finalizados serão perdidos.\n\nDeseja realmente sair?')) {
            $('#solicitarCotacaoModal').modal('hide');
            setTimeout(() => location.reload(), 300);
        }
    });

    // 5. MODAL VENCEDOR INTEGRAL
    const confirmarVencedorModal = document.getElementById('confirmarVencedorModal');
    // Variáveis globais para gerenciar divergências
    let cotacaoAtualId = null;
    let dadosCotacaoAtual = null;

    // Handler para botões de selecionar vencedora
    $(document).on('click', '.btn-selecionar-vencedora', function() {
        cotacaoAtualId = $(this).data('cotacao-id');
        
        // Busca dados da cotação ANTES de abrir qualquer modal
        fetch(`/api/dados-confirmacao-rm/${cotacaoAtualId}/`)
            .then(r => r.json())
            .then(data => {
                dadosCotacaoAtual = data;
                
                // Decide qual modal abrir baseado na conformidade
                if (data.conformidade !== 'verde') {
                    // Se houver divergência, abre APENAS o modal de divergência
                    abrirModalDivergencia(cotacaoAtualId, data);
                } else {
                    // Se não houver divergência, abre o modal detalhado
                    const modalBody = $('#confirmarVencedorBody');
                    $('#formConfirmarVencedor').attr('action', `/cotacao/${cotacaoAtualId}/selecionar/`);
                    
                    // Se existirem pendentes, prepara alerta que ficará em destaque
                    let pendentesHtml = '';
                    if (data.pendentes && data.pendentes.length > 0) {
                        pendentesHtml = `
                            <div class="alert alert-warning mb-3" style="font-size:0.95rem;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Atenção:</strong> <span class="fw-semibold">${data.pendentes.length} fornecedor${data.pendentes.length > 1 ? 'es' : ''} ainda não respondeu.</span>
                                <div class="small text-muted mt-1">Se prosseguir, as respostas pendentes serão ignoradas e a cotação dos fornecedores pendentes não será considerada.</div>
                                <ul class="mb-0 mt-2">
                                    ${data.pendentes.map(f => `<li class="text-muted">${f}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // Constrói HTML detalhado com cores suaves e minimalistas
                    let htmlContent = `
                        ${pendentesHtml}
                        <!-- Badge de Conformidade -->
                        <div class="alert alert-light border border-success mb-3" style="background-color: #f0f9f4;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                                <div>
                                    <h6 class="mb-1 fw-bold text-success">✓ Proposta Conforme</h6>
                                    <small class="text-muted">Esta cotação atende todos os requisitos solicitados.</small>
                                </div>
                            </div>

                        </div>

                        <!-- Dados do Fornecedor -->
                        <div class="card mb-3 border" style="border-color: #e8f5e9 !important;">
                            <div class="card-header py-2" style="background-color: #f0f9f4; border-bottom: 1px solid #e8f5e9;">
                                <i class="fas fa-building me-2 text-success"></i><strong class="text-dark">Dados do Fornecedor</strong>
                            </div>
                            <div class="card-body bg-white">
                                <div class="row g-2 small">
                                    <div class="col-12">
                                        <strong class="text-secondary">Nome:</strong> <span class="text-dark">${data.fornecedor.nome_fantasia}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-secondary">CNPJ:</strong> <span class="text-dark">${data.fornecedor.cnpj}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-secondary">Email:</strong> <span class="text-dark">${data.fornecedor.email}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-secondary">Telefone:</strong> <span class="text-dark">${data.fornecedor.telefone}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="text-secondary">Contato:</strong> <span class="text-dark">${data.fornecedor.contato_nome}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comparativo de Condições -->
                        <div class="card mb-3 border" style="border-color: #e8f5e9 !important;">
                            <div class="card-header py-2" style="background-color: #f0f9f4; border-bottom: 1px solid #e8f5e9;">
                                <i class="fas fa-balance-scale me-2 text-success"></i><strong class="text-dark">Comparativo - Solicitado vs Oferecido</strong>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead style="background-color: #fafafa;">
                                            <tr>
                                                <th width="25%" class="text-secondary fw-normal">Item</th>
                                                <th width="35%" class="text-secondary fw-normal">Solicitado</th>
                                                <th width="40%" class="text-secondary fw-normal">Oferecido</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><i class="fas fa-calendar-check me-2 text-muted"></i>Prazo de Entrega</td>
                                                <td class="text-muted">${data.solicitado.prazo || 'Prazo flexível'}</td>
                                                <td class="text-dark">${data.vencedora.prazo} ${(() => {
                                                    const solicitadoPrazo = data.solicitado.prazo || 'Prazo flexível';
                                                    const vencedoraPrazo = data.vencedora.prazo;
                                                    // Considera conforme se: igual ao solicitado, ou contém "Atende", ou é "Não informado" quando solicitado é flexível
                                                    const conforme = vencedoraPrazo === solicitadoPrazo || 
                                                                    vencedoraPrazo.includes('Atende') || 
                                                                    (vencedoraPrazo === 'Não informado' && solicitadoPrazo === 'Prazo flexível');
                                                    return conforme ? '<span class="badge" style="background-color: #e8f5e9; color: #2e7d32;">✓ Conforme</span>' : '<span class="badge bg-danger">⚠ ALTERADO</span>';
                                                })()}</td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-credit-card me-2 text-muted"></i>Pagamento</td>
                                                <td class="text-muted">${data.solicitado.pagamento || 'Não definido'}</td>
                                                <td class="text-dark">${data.vencedora.pagamento} ${(() => {
                                                    const solicitadoPagto = data.solicitado.pagamento || 'Não definido';
                                                    const vencedoraPagto = data.vencedora.pagamento;
                                                    // Considera conforme se: igual ao solicitado, ou contém "Atende", ou é "Não informado" quando solicitado é "Não definido"
                                                    const conforme = vencedoraPagto === solicitadoPagto || 
                                                                    vencedoraPagto.includes('Atende') ||
                                                                    (vencedoraPagto === 'Não informado' && solicitadoPagto === 'Não definido');
                                                    return conforme ? '<span class="badge" style="background-color: #e8f5e9; color: #2e7d32;">✓ Conforme</span>' : '<span class="badge bg-warning text-dark">⚠ ALTERADO</span>';
                                                })()}</td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-map-marker-alt me-2 text-muted"></i>Local de Entrega</td>
                                                <td class="text-muted">${data.solicitado.local || 'Não especificado'}</td>
                                                <td class="text-dark">${data.vencedora.local} ${(() => {
                                                    const solicitadoLocal = data.solicitado.local || 'Não especificado';
                                                    const vencedoraLocal = data.vencedora.local;
                                                    const conforme = vencedoraLocal === solicitadoLocal || (vencedoraLocal === 'Não informado' && solicitadoLocal === 'Não especificado');
                                                    return conforme ? '<span class="badge" style="background-color: #e8f5e9; color: #2e7d32;">✓ Conforme</span>' : '<span class="badge bg-danger">⚠ ALTERADO</span>';
                                                })()}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Itens da Cotação -->
                        <div class="card mb-3 border" style="border-color: #e8f5e9 !important;">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center" style="background-color: #f0f9f4; border-bottom: 1px solid #e8f5e9;">
                                <span><i class="fas fa-shopping-cart me-2 text-success"></i><strong class="text-dark">Itens da Cotação (${data.itens.length} ${data.itens.length === 1 ? 'item' : 'itens'})</strong></span>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseItens" aria-expanded="false">
                                    <i class="fas fa-eye me-1"></i>Ver Detalhes
                                </button>
                            </div>
                            <div class="collapse" id="collapseItens">
                                <div class="card-body p-0">
                                    <div style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                                        <table class="table table-sm table-hover mb-0" style="table-layout: fixed; width: 100%;">
                                            <thead class="sticky-top" style="background-color: #fafafa;">
                                                <tr>
                                                    <th class="text-secondary fw-normal" style="background-color: #fafafa; width: 40%;">Descrição</th>
                                                    <th class="text-center text-secondary fw-normal" style="background-color: #fafafa; width: 10%;">Qtd</th>
                                                    <th class="text-center text-secondary fw-normal" style="background-color: #fafafa; width: 10%;">Un.</th>
                                                    <th class="text-end text-secondary fw-normal" style="background-color: #fafafa; width: 20%;">Preço Unit.</th>
                                                    <th class="text-end text-secondary fw-normal" style="background-color: #fafafa; width: 20%;">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                    `;
                    
                    // Adiciona cada item
                    data.itens.forEach(item => {
                        htmlContent += `
                            <tr>
                                <td class="text-dark text-truncate" title="${item.descricao}">${item.descricao}</td>
                                <td class="text-center text-muted">${item.quantidade}</td>
                                <td class="text-center text-muted">${item.unidade}</td>
                                <td class="text-end text-muted">${item.preco_unitario}</td>
                                <td class="text-end fw-bold text-dark">${item.subtotal}</td>
                            </tr>
                        `;
                    });
                    
                    htmlContent += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Valores Totais -->
                        <div class="card mb-3 border" style="border-color: #e8f5e9 !important;">
                            <div class="card-header py-2" style="background-color: #f0f9f4; border-bottom: 1px solid #e8f5e9;">
                                <i class="fas fa-calculator me-2 text-success"></i><strong class="text-dark">Valores</strong>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-secondary">Subtotal dos Itens:</span>
                                    <strong class="text-dark">R$ ${data.vencedora.subtotal_itens}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                                    <span class="text-secondary">Valor do Frete:</span>
                                    <strong class="text-dark">R$ ${data.vencedora.frete}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="fs-5 fw-bold text-dark">Valor Total:</span>
                                    <span class="fs-4 fw-bold" style="color: #2e7d32;">R$ ${data.vencedora.valor_total}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Adiciona observações se existirem
                    if (data.vencedora.observacoes && data.vencedora.observacoes.trim()) {
                        htmlContent += `
                            <div class="card mb-3 border" style="border-color: #e0e0e0 !important;">
                                <div class="card-header py-2" style="background-color: #f5f5f5; border-bottom: 1px solid #e0e0e0;">
                                    <i class="fas fa-comment-dots me-2 text-secondary"></i><strong class="text-dark">Observações do Fornecedor</strong>
                                </div>
                                <div class="card-body">
                                    <p class="mb-0 small text-dark">${data.vencedora.observacoes}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    // (Alertas de pendentes já inseridos no topo; não duplicar aqui.)
                    
                    // Adiciona informações de rastreabilidade
                    htmlContent += `
                        <div class="small text-muted text-center pt-2 border-top">
                            <i class="fas fa-clock me-1"></i>Convite enviado: ${data.data_envio} | 
                            <i class="fas fa-reply me-1"></i>Resposta recebida: ${data.data_resposta}
                        </div>
                    `;
                    
                    modalBody.html(htmlContent);
                    
                    // Abre o modal de confirmação detalhado
                    new bootstrap.Modal(document.getElementById('confirmarVencedorModal')).show();
                }
            })
            .catch(error => {
                console.error('Erro ao buscar dados da cotação:', error);
                alert('Erro ao carregar dados da cotação. Tente novamente.');
            });
    });

    // Função para abrir modal de divergência com dados detalhados
    function abrirModalDivergencia(cotacaoId, dados) {
        const tabelaComparacao = $('#tabelaComparacaoDivergencias');
        let linhasTabela = '';

        // Compara Prazo de Entrega
        const prazoSolicitado = dados.solicitado?.prazo || 'Prazo flexível';
        const prazoOfertado = dados.vencedora?.prazo || 'Não informado';
        const prazoStatus = prazoOfertado === 'Atende' || prazoOfertado === prazoSolicitado ? 
            '<span class="badge bg-success">OK</span>' : 
            '<span class="badge bg-danger">DIFERENTE</span>';
        
        linhasTabela += `
            <tr>
                <td class="fw-bold"><i class="fas fa-calendar-check me-2 text-muted"></i>Prazo de Entrega</td>
                <td>${prazoSolicitado}</td>
                <td>${prazoOfertado} ${prazoStatus}</td>
            </tr>
        `;

        // Compara Forma de Pagamento
        const pagtoSolicitado = dados.solicitado?.pagamento || 'Não definido';
        const pagtoOfertado = dados.vencedora?.pagamento || 'Não informado';
        const pagtoStatus = pagtoOfertado === 'Atende' || pagtoOfertado === pagtoSolicitado ? 
            '<span class="badge bg-success">OK</span>' : 
            '<span class="badge bg-warning">DIFERENTE</span>';
        
        linhasTabela += `
            <tr>
                <td class="fw-bold"><i class="fas fa-credit-card me-2 text-muted"></i>Pagamento</td>
                <td>${pagtoSolicitado}</td>
                <td>${pagtoOfertado} ${pagtoStatus}</td>
            </tr>
        `;

        // Compara Local de Entrega
        const localSolicitado = dados.solicitado?.local || 'Não especificado';
        const localOfertado = dados.vencedora?.local || 'Não informado';
        const localStatus = localOfertado === localSolicitado ? 
            '<span class="badge bg-success">OK</span>' : 
            '<span class="badge bg-danger">DIFERENTE</span>';
        
        linhasTabela += `
            <tr>
                <td class="fw-bold"><i class="fas fa-map-marker-alt me-2 text-muted"></i>Local de Entrega</td>
                <td>${localSolicitado}</td>
                <td>${localOfertado} ${localStatus}</td>
            </tr>
        `;

        tabelaComparacao.html(linhasTabela);
        
        // Limpa campos anteriores
        $('#justificativaDivergencia').val('');
        $('#senhaDivergencia').val('');
        $('#erroDivergencia').addClass('d-none');

        // Abre o modal
        new bootstrap.Modal(document.getElementById('modalDivergencia')).show();
    }

    // Handler para confirmar divergência com senha
    $('#btnConfirmarDivergencia').click(function() {
        const justificativa = $('#justificativaDivergencia').val().trim();
        const senha = $('#senhaDivergencia').val().trim();
        const erroDiv = $('#erroDivergencia');

        // Validações
        if (!justificativa || justificativa.length < 5) {
            erroDiv.removeClass('d-none').text('Por favor, forneça uma justificativa detalhada (mínimo 5 caracteres).');
            return;
        }

        if (!senha) {
            erroDiv.removeClass('d-none').text('A senha é obrigatória para aprovar cotações divergentes.');
            return;
        }

        // Desabilita botão durante validação
        $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Validando...');

        // Valida senha via API
        fetch('/api/validar-senha/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ senha: senha })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Senha correta - submete formulário principal com justificativa
                const form = $('#formConfirmarVencedor');
                
                // CRÍTICO: Define o action do formulário antes de submeter
                form.attr('action', `/cotacao/${cotacaoAtualId}/selecionar/`);
                
                // Adiciona campo oculto com justificativa
                form.append(`<input type="hidden" name="justificativa_diretoria" value="${justificativa}">`);
                
                // Fecha modal de divergência
                bootstrap.Modal.getInstance(document.getElementById('modalDivergencia')).hide();
                
                // Submete o formulário
                form.submit();
            } else {
                // Senha incorreta
                erroDiv.removeClass('d-none').text('Senha incorreta. Por favor, tente novamente.');
                $('#btnConfirmarDivergencia').prop('disabled', false).html('<i class="fas fa-check me-2"></i>CONFIRMAR E APROVAR');
            }
        })
        .catch(error => {
            erroDiv.removeClass('d-none').text('Erro ao validar senha. Tente novamente.');
            $('#btnConfirmarDivergencia').prop('disabled', false).html('<i class="fas fa-check me-2"></i>CONFIRMAR E APROVAR');
        });
    });

    // 6. EXCLUSÃO E REJEIÇÃO (ORIGINAIS RESTAURADOS)
    window.abrirModalRejeicao = function(scId, scName) {
        const modalId = 'modalRejeicaoSC';
        const modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-danger text-white border-0">
                            <h5 class="modal-title"><i class="fas fa-times-circle me-2"></i>Rejeitar Solicitação</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Atenção:</strong> Esta ação rejeitará a solicitação e notificará o solicitante.
                            </div>
                            <p class="mb-3"><strong>SC:</strong> ${scName}</p>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-danger">Motivo da Rejeição *</label>
                                <textarea id="motivoRejeicaoInput" class="form-control" rows="4" 
                                          placeholder="Explique detalhadamente o motivo da rejeição desta solicitação..." 
                                          required></textarea>
                                <small class="form-text text-muted">Mínimo 10 caracteres. Este motivo será enviado ao solicitante.</small>
                            </div>
                            <div id="erroRejeicao" class="alert alert-danger d-none"></div>
                        </div>
                        <div class="modal-footer border-0 bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger fw-bold px-4" id="btnConfirmarRejeicaoSC">
                                <i class="fas fa-times me-1"></i>Confirmar Rejeição
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#' + modalId).remove();
        $('body').append(modalHtml);
        const modalEl = document.getElementById(modalId);
        const bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();
        
        $('#btnConfirmarRejeicaoSC').on('click', function() {
            const motivo = $('#motivoRejeicaoInput').val().trim();
            const erroDiv = $('#erroRejeicao');
            
            if (!motivo || motivo.length < 10) {
                erroDiv.removeClass('d-none').text('Por favor, forneça um motivo detalhado (mínimo 10 caracteres).');
                return;
            }
            
            const form = document.getElementById('rejectForm');
            form.action = `/solicitacao/${scId}/rejeitar-escritorio/`;
            document.getElementById('rejectMotivo').value = motivo;
            form.submit();
        });
    };

    let formExcluir = null;
    window.abrirModalExclusao = (btn, tipo, fornecedorNome, cotacaoId) => {
        formExcluir = btn.closest('form');
        let msg = '';
        
        if (tipo === 'fornecedor') {
            msg = "Tem certeza que deseja cancelar este convite? O fornecedor perderá o acesso imediato ao portal e será necessário gerar um novo convite manual ou automático caso mude de ideia.";
        } else if (tipo === 'cotação') {
            msg = `<strong>⚠️ ATENÇÃO: Esta ação é IRREVERSÍVEL!</strong><br><br>Ao excluir a cotação de <strong>${fornecedorNome || 'este fornecedor'}</strong>, todos os seguintes dados serão <strong>PERMANENTEMENTE APAGADOS</strong>:<br><br>
            <ul class="text-start mb-0">
                <li>Todos os preços registrados</li>
                <li>Condições de pagamento e prazos</li>
                <li>Histórico de negociação com este fornecedor</li>
                <li>Observações e anexos vinculados</li>
            </ul><br>
            <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>O fornecedor <strong>NÃO SERÁ NOTIFICADO</strong> sobre a exclusão. Esta operação não pode ser desfeita.
            </div>`;
        } else {
            msg = "Esta ação é irreversível. Tem certeza que deseja continuar?";
        }
        
        $('#mensagemExclusao').html(msg);
        new bootstrap.Modal(document.getElementById('modalConfirmarExclusao')).show();
    };
    $('#btnConfirmarExclusaoFinal').click(() => { if (formExcluir) { $('#btnConfirmarExclusaoFinal').prop('disabled', true); formExcluir.submit(); } });

    // Confirmação adicional ao gerar RM se houver fornecedores pendentes (usando modal padrão)
    let confirmProceedConfirmed = false;
    $('#formConfirmarVencedor').on('submit', function(e) {
        if (confirmProceedConfirmed) return true;

        if (dadosCotacaoAtual && dadosCotacaoAtual.pendentes && dadosCotacaoAtual.pendentes.length > 0) {
            e.preventDefault();
            const nomes = dadosCotacaoAtual.pendentes.map(f => `• ${f}`).join('<br>');
            $('#confirmProceedMessage').html(`Existem fornecedores que ainda não responderam:<br>${nomes}`);
            new bootstrap.Modal(document.getElementById('confirmProceedModal')).show();
            return false;
        }
        return true;
    });

    // Botão de confirmação no modal estilizado
    $('#confirmProceedBtn').click(function() {
        confirmProceedConfirmed = true;
        $('#confirmProceedModal').modal('hide');
        $('#formConfirmarVencedor')[0].submit();
    });
});
</script>
{% endblock %}