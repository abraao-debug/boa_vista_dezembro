{% extends 'materiais/base.html' %}
{% block title %}Editar Solicitação de Compra{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    {% include 'materiais/styles_dashboard.css' %}
    .item-adicionado { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: .375rem; padding: .75rem 1rem; }
    #itemsListContainer { max-height: 350px; overflow-y: auto; overflow-x: hidden; padding-right: 5px; }
    .select2-container--default .select2-selection--single { height: calc(1.5em + .75rem + 2px); padding: .375rem .75rem; border: 1px solid #ced4da; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 1.5; padding-left: 0; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(1.5em + .75rem); }
    .select2-results__options { max-height: 350px !important; overflow-y: auto !important; }

    /* AJUSTE VISUAL PARA O BOTÃO DE EMERGÊNCIA */
    .emergency-box {
        display: flex;
        align-items: center;
    }
    .emergency-box .form-check.form-switch {
        font-size: 1.25rem;
        padding-left: 0;
        display: inline-flex;
        align-items: center;
    }
    .emergency-box .form-check-input { 
        width: 3em; 
        height: 1.5em; 
        float: none;
        margin-left: 0;
    }
    .emergency-box .form-check-label {
        margin-left: 0.75rem;
    }

    /* MODAL MELHORADO - Layout em duas colunas */
    #addItemModal .modal-body {
        max-height: 75vh;
        overflow: hidden;
    }
    
    /* Coluna direita - lista de itens adicionados */
    #colunaItensAdicionados {
        min-height: 450px;
    }
    #listaItensModal .item-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }
    #listaItensModal .item-card:hover {
        border-color: #dc3545;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.15);
    }
    #listaItensModal .item-card .item-info {
        flex: 1;
        min-width: 0;
    }
    #listaItensModal .item-card .item-desc {
        font-size: 0.8rem;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #listaItensModal .item-card .item-qty {
        font-size: 0.7rem;
        color: #6c757d;
    }
    #listaItensModal .item-card .btn-remove {
        padding: 2px 8px;
        font-size: 0.7rem;
        flex-shrink: 0;
        margin-left: 8px;
    }
</style>

<form method="POST" id="mainForm">
    {% csrf_token %}
    <input type="hidden" name="itens_json" id="itensJsonInput">

    <div class="d-flex align-items-center mb-4">
        <a href="{% url 'materiais:gerenciar_cotacoes' %}" class="btn btn-secondary me-3"><i class="fas fa-arrow-left"></i> Voltar</a>
        <div>
            <h4 class="mb-0">Editar Solicitação ({{ solicitacao.numero }})</h4>
            <p class="text-muted mb-0">Ajuste os dados e os itens da solicitação de compra.</p>
        </div>
    </div>
    <hr class="mb-4">

    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5>Informações Gerais</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Solicitante</label><input type="text" class="form-control" value="{{ solicitacao.solicitante.get_full_name|default:solicitacao.solicitante.username }}" disabled></div>
                        <div class="col-md-4 mb-3">
                            <label for="categoria_sc" class="form-label">Categoria da SC</label>
                            <select class="form-select" id="categoria_sc" name="categoria_sc"><option value="">Nenhuma</option>{% for cat_sc in categorias_sc %}<option value="{{ cat_sc.id }}" {% if solicitacao.categoria_sc_id == cat_sc.id %}selected{% endif %}>{{ cat_sc.nome }}</option>{% endfor %}</select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="obra" class="form-label">Obra *</label>
                            <select class="form-select" id="obra" name="obra" required>{% for o in obras %}<option value="{{ o.id }}" {% if o.id == solicitacao.obra_id %}selected{% endif %}>{{ o.nome }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="data_necessidade" class="form-label">Data Necessária *</label>
                            <input type="date" class="form-control" id="data_necessidade" name="data_necessidade" value="{{ solicitacao.data_necessidade|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="destino" class="form-label">Destino de Entrega</label>
                            <select class="form-select" id="destino" name="destino"><option value="">Mesmo endereço da obra</option>{% for destino in destinos_entrega %}<option value="{{ destino.id }}" {% if solicitacao.destino_id == destino.id %}selected{% endif %}>{{ destino.nome }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="mb-3"><label for="justificativa" class="form-label">Observação Geral</label><textarea class="form-control" id="justificativa" name="justificativa" rows="3">{{ solicitacao.justificativa }}</textarea></div>
                    <div class="emergency-box"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="is_emergencial" name="is_emergencial" {% if solicitacao.is_emergencial %}checked{% endif %}><label class="form-check-label" for="is_emergencial"><i class="fas fa-exclamation-triangle"></i> Solicitação Emergencial</label></div></div>
                </div>
            </div>
        </div>
        <div class="col-lg-5 mb-4">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3"><h5>Itens da Solicitação (<span id="itemCount">0</span>)</h5><button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal"><i class="fas fa-plus"></i> Adicionar Item</button></div>
                    <div id="itemsListContainer" class="flex-grow-1"><div id="placeholder" class="text-center p-4 text-muted d-flex flex-column justify-content-center align-items-center h-100"><i class="fas fa-box-open fa-3x mb-3"></i><p class="mb-2">Nenhum item adicionado.</p></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-end mt-2"><a href="{% url 'materiais:gerenciar_cotacoes' %}" class="btn btn-light border">Cancelar</a><button type="submit" class="btn btn-primary px-4">Salvar Alterações</button></div>
</form>

<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Adicionar Itens à Solicitação</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <!-- COLUNA ESQUERDA: Busca e adição de itens -->
                    <div class="col-md-7 p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-search me-1"></i>Buscar Item no Catálogo</label>
                            <select class="form-select" id="itemCatalogoSelect" style="width: 100%;"></select>
                        </div>
                        
                        <!-- Filtros: sempre visíveis (categoria e subcategoria) -->
                        <div class="mb-3">
                            <label class="form-label small text-muted"><i class="fas fa-filter me-1"></i>Filtrar por categoria</label>
                            <div class="mt-2">
                                <div class="row">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="filtroCategoria">
                                            <option value="" selected>Todas Categorias</option>
                                            {% for cat in categorias_principais %}<option value="{{ cat.id }}">{{ cat.nome }}</option>{% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="filtroSubcategoria" disabled>
                                            <option value="">Subcategoria...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detalhes do item selecionado -->
                        <div id="itemDetails" class="d-none">
                            <div class="card border-success mb-3">
                                <div class="card-header bg-success-subtle py-2">
                                    <strong class="small text-success"><i class="fas fa-box me-1"></i>Item Selecionado</strong>
                                </div>
                                <div class="card-body py-2">
                                    <p id="detailDescricao" class="fw-bold mb-1 small"></p>
                                    <small class="text-muted">Unidade: <span id="detailUnidade" class="fw-bold"></span></small>
                                </div>
                            </div>
                            
                            <form id="formAdicionarItem">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label for="quantidadeInput" class="form-label small mb-1">Quantidade *</label>
                                        <input type="number" class="form-control" id="quantidadeInput" min="0.01" step="0.01" required>
                                    </div>
                                    <div class="col-6">
                                        <label for="observacaoInput" class="form-label small mb-1">Observação</label>
                                        <input type="text" class="form-control" id="observacaoInput" placeholder="Opcional...">
                                    </div>
                                </div>
                            </form>
                            
                            <!-- Aviso de item duplicado -->
                            <div id="avisoDuplicado" class="alert alert-warning d-none small py-2 mt-2 mb-0">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <span id="avisoDuplicadoTexto"></span>
                            </div>
                        </div>
                        
                        <!-- Placeholder quando nenhum item selecionado -->
                        <div id="itemPlaceholder" class="text-center text-muted py-5">
                            <i class="fas fa-hand-pointer fa-3x mb-3 opacity-25"></i>
                            <p class="mb-0">Selecione um item do catálogo acima</p>
                            <small>Use a busca ou os filtros para encontrar itens</small>
                        </div>
                    </div>
                    
                    <!-- COLUNA DIREITA: Lista de itens adicionados -->
                    <div class="col-md-5 bg-light border-start" id="colunaItensAdicionados">
                        <div class="p-3 bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-shopping-cart me-2"></i><strong>Itens na SC</strong></span>
                                <span class="badge bg-white text-success fs-6" id="countItensModal">0</span>
                            </div>
                        </div>
                        <div id="listaItensModal" style="max-height: 380px; overflow-y: auto; padding: 12px;">
                            <div id="placeholderItensModal" class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                                <p class="mb-1">Nenhum item adicionado</p>
                                <small>Os itens aparecerão aqui</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" form="formAdicionarItem" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSomarQuantidade" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning py-2">
                <h6 class="modal-title text-dark"><i class="fas fa-exclamation-circle me-2"></i>Item já existe na lista</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4">
                <div class="text-center mb-3">
                    <i class="fas fa-layer-group fa-3x text-warning mb-2"></i>
                </div>
                <p class="text-center mb-2">
                    <strong id="somarItemDescricao">-</strong>
                </p>
                <div class="bg-light rounded p-3 mb-3">
                    <div class="row text-center">
                        <div class="col-5">
                            <small class="text-muted d-block">Quantidade atual</small>
                            <strong class="fs-5 text-secondary" id="somarQtdAtual">0</strong>
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <i class="fas fa-plus text-success"></i>
                        </div>
                        <div class="col-5">
                            <small class="text-muted d-block">Nova quantidade</small>
                            <strong class="fs-5 text-primary" id="somarQtdNova">0</strong>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="text-center">
                        <small class="text-muted d-block">Total após soma</small>
                        <strong class="fs-4 text-success" id="somarQtdTotal">0</strong>
                        <span class="text-muted" id="somarUnidade"></span>
                    </div>
                </div>
                <p class="text-center text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Deseja somar as quantidades?
                </p>
            </div>
            <div class="modal-footer border-0 justify-content-center py-2">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarSoma">
                    <i class="fas fa-check me-1"></i>Sim, Somar Quantidades
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Carrega os itens existentes da SC que está sendo editada
    let itemsList = JSON.parse('{{ itens_existentes_json|escapejs }}');
    let catalogItems = [];

    const itemCatalogoSelect = $('#itemCatalogoSelect');
    const mainForm = document.getElementById('mainForm');
    const hiddenInput = document.getElementById('itensJsonInput');
    const itemsListContainer = document.getElementById('itemsListContainer');
    const placeholder = document.getElementById('placeholder');
    const itemCountSpan = document.getElementById('itemCount');
    const filtroCategoria = $('#filtroCategoria');
    const filtroSubcategoria = $('#filtroSubcategoria');
    
    // Inicializa todos os componentes Select2 da página
    $('#categoria_sc').select2();
    $('#obra').select2();
    $('#destino').select2();
    filtroCategoria.select2({ dropdownParent: $('#addItemModal') });
    filtroSubcategoria.select2({ dropdownParent: $('#addItemModal') });

    // Quando a obra muda, atualiza o select de destino para esconder a obra selecionada
    $('#obra').on('change', function() {
        const obraId = $(this).val();
        const $destino = $('#destino');
        
        // Mostra todas as opções primeiro
        $destino.find('option').show();
        
        // Esconde a obra selecionada (para não duplicar)
        if (obraId) {
            $destino.find(`option[value="${obraId}"]`).hide();
        }
        
        // Se o destino selecionado era a mesma obra, limpa
        if ($destino.val() === obraId) {
            $destino.val('').trigger('change');
        }
    });

    // Renderiza itens existentes
    if (itemsList.length > 0) {
        renderItems();
    }

    // Função para verificar se item já foi adicionado
    function verificarItemDuplicado(itemId, descricao) {
        const duplicadoExato = itemsList.find(i => i.item_id == itemId);
        if (duplicadoExato) {
            return { tipo: 'exato', item: duplicadoExato };
        }
        
        // Verifica similaridade simples (palavras em comum)
        const palavrasNovo = descricao.toUpperCase().split(/\s+/).filter(p => p.length > 3);
        for (const item of itemsList) {
            const palavrasExistente = item.descricao.toUpperCase().split(/\s+/).filter(p => p.length > 3);
            const palavrasComuns = palavrasNovo.filter(p => palavrasExistente.includes(p));
            const similaridade = (palavrasComuns.length / Math.max(palavrasNovo.length, 1)) * 100;
            if (similaridade >= 60) {
                return { tipo: 'similar', item: item, similaridade: Math.round(similaridade) };
            }
        }
        return null;
    }

    // Atualiza lista de itens já adicionados no modal (coluna direita)
    function atualizarListaItensModal() {
        const container = $('#listaItensModal');
        const placeholder = $('#placeholderItensModal');
        
        $('#countItensModal').text(itemsList.length);
        
        if (itemsList.length === 0) {
            container.html(`<div id="placeholderItensModal" class="text-center text-muted py-4">
                <i class="fas fa-box-open fa-2x mb-2 opacity-50"></i>
                <p class="small mb-0">Nenhum item adicionado ainda.</p>
            </div>`);
            return;
        }
        
        let html = '';
        itemsList.forEach((item, index) => {
            html += `<div class="item-card" title="${item.descricao}">
                <div class="item-info">
                    <div class="item-desc">${item.descricao}</div>
                    <div class="item-qty"><i class="fas fa-cube me-1"></i>${item.quantidade} ${item.unidade}</div>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm btn-remove remove-item-modal" data-index="${index}" title="Remover item">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        });
        container.html(html);
    }

    // Handler para remover item direto do modal
    $(document).on('click', '.remove-item-modal', function() {
        const index = $(this).data('index');
        itemsList.splice(index, 1);
        renderItems();
        atualizarListaItensModal();
    });

    // Função central para carregar itens no select principal
    function carregarItens(categoriaId = null, subcategoriaId = null) {
        let url = `/api/itens-filtrados/`;
        let params = new URLSearchParams();

        if (subcategoriaId) {
            params.append('subcategoria_id', subcategoriaId);
        } else if (categoriaId) {
            params.append('categoria_id', categoriaId);
        }
        
        if (params.toString()) {
            url += `?${params.toString()}`;
        }

        itemCatalogoSelect.empty().prop('disabled', true).select2({ 
            placeholder: "Carregando itens...",
            dropdownParent: $('#addItemModal'),
            data: []
        });

        fetch(url)
            .then(response => response.json())
            .then(data => {
                catalogItems = data;
                const itemsParaSelect = data.map(item => ({id: item.id, text: `${item.codigo} - ${item.descricao}`}));
                
                itemCatalogoSelect.empty().select2({
                    placeholder: "Busque pelo código ou descrição do item...",
                    dropdownParent: $('#addItemModal'),
                    data: itemsParaSelect
                }).prop('disabled', false).val(null).trigger('change');
            });
    }

    // Ao abrir o modal, reseta os filtros e carrega todos os itens
    $('#addItemModal').on('show.bs.modal', function () {
        filtroCategoria.val(null).trigger('change');
        filtroSubcategoria.empty().append('<option value="">Selecione uma categoria...</option>').prop('disabled', true).trigger('change');
        carregarItens();
        atualizarListaItensModal();
        // Limpa aviso de duplicado
        $('#avisoDuplicado').addClass('d-none');
    });

    // Evento para o filtro de Categoria
    filtroCategoria.on('change', function() {
        const categoriaId = $(this).val();
        filtroSubcategoria.empty().prop('disabled', true);
        carregarItens(categoriaId, null);

        if (!categoriaId) {
            filtroSubcategoria.append('<option value="">Selecione uma categoria...</option>').trigger('change');
            return;
        }

        filtroSubcategoria.append('<option value="">Carregando...</option>').trigger('change');
        fetch(`/api/subcategorias/${categoriaId}/`)
            .then(response => response.json())
            .then(data => {
                filtroSubcategoria.empty().append('<option value="" selected>Todas as subcategorias</option>');
                $.each(data, function(i, sub) {
                    filtroSubcategoria.append(new Option(sub.nome, sub.id));
                });
                filtroSubcategoria.prop('disabled', false).trigger('change');
            });
    });

    // Evento para o filtro de Subcategoria
    filtroSubcategoria.on('change', function() {
        const categoriaId = filtroCategoria.val();
        const subcategoriaId = $(this).val();
        carregarItens(categoriaId, subcategoriaId);
    });

    // Ao selecionar um item, verifica duplicidade
    itemCatalogoSelect.on('change', function() {
        const selectedId = $(this).val();
        const selectedItem = catalogItems.find(item => item.id == selectedId);
        const detailsDiv = document.getElementById('itemDetails');
        const placeholderDiv = document.getElementById('itemPlaceholder');
        const avisoDuplicado = $('#avisoDuplicado');
        const avisoDuplicadoTexto = $('#avisoDuplicadoTexto');
        
        avisoDuplicado.addClass('d-none');
        
        if (selectedItem) {
            document.getElementById('detailDescricao').textContent = selectedItem.descricao;
            document.getElementById('detailUnidade').textContent = selectedItem.unidade__sigla;
            detailsDiv.classList.remove('d-none');
            placeholderDiv.classList.add('d-none');
            
            // Foca no campo de quantidade
            setTimeout(() => document.getElementById('quantidadeInput').focus(), 100);
            
            // Verifica duplicidade
            const resultado = verificarItemDuplicado(selectedId, selectedItem.descricao);
            if (resultado) {
                if (resultado.tipo === 'exato') {
                    avisoDuplicadoTexto.html(`<strong>Item já adicionado!</strong> Este item exato já está na sua lista com quantidade: ${resultado.item.quantidade} ${resultado.item.unidade}`);
                    avisoDuplicado.removeClass('d-none alert-warning').addClass('alert-danger');
                } else {
                    avisoDuplicadoTexto.html(`<strong>Item semelhante encontrado!</strong> "${resultado.item.descricao}" (${resultado.similaridade}% similar). Verifique se não é duplicidade.`);
                    avisoDuplicado.removeClass('d-none alert-danger').addClass('alert-warning');
                }
            }
        } else {
            detailsDiv.classList.add('d-none');
            placeholderDiv.classList.remove('d-none');
        }
    });

    // Usa o submit do form para validação nativa do browser
    let itemParaSomar = null; // Armazena dados do item duplicado para somar
    
    $('#formAdicionarItem').on('submit', function(e) {
        e.preventDefault();
        
        const selectedId = itemCatalogoSelect.val();
        if (!selectedId) { 
            alert('Por favor, selecione um item do catálogo.'); 
            return; 
        }
        
        const quantidade = parseFloat(document.getElementById('quantidadeInput').value);
        const selectedItem = catalogItems.find(item => item.id == selectedId);
        
        // Verifica se é duplicado exato
        const resultado = verificarItemDuplicado(selectedId, '');
        if (resultado && resultado.tipo === 'exato') {
            // Guarda os dados para usar no callback do modal
            itemParaSomar = {
                itemId: selectedId,
                novaQuantidade: quantidade,
                quantidadeAtual: resultado.item.quantidade,
                unidade: resultado.item.unidade,
                descricao: resultado.item.descricao,
                observacao: document.getElementById('observacaoInput').value.trim(),
                indexExistente: itemsList.findIndex(i => i.item_id == selectedId)
            };
            
            // Preenche o modal com os dados
            $('#somarItemDescricao').text(selectedItem.descricao);
            $('#somarQtdAtual').text(resultado.item.quantidade);
            $('#somarQtdNova').text(quantidade);
            $('#somarQtdTotal').text(parseFloat(resultado.item.quantidade) + quantidade);
            $('#somarUnidade').text(resultado.item.unidade);
            
            // Abre o modal de confirmação
            $('#modalSomarQuantidade').modal('show');
            return;
        }
        
        adicionarItemNaLista(selectedItem, quantidade);
    });
    
    // Callback do botão de confirmar soma
    $('#btnConfirmarSoma').on('click', function() {
        if (itemParaSomar) {
            // Soma a quantidade no item existente
            const novaQuantidade = parseFloat(itemParaSomar.quantidadeAtual) + parseFloat(itemParaSomar.novaQuantidade);
            itemsList[itemParaSomar.indexExistente].quantidade = novaQuantidade;
            
            // Atualiza observação se uma nova foi fornecida
            if (itemParaSomar.observacao) {
                const obsAtual = itemsList[itemParaSomar.indexExistente].observacao || '';
                if (obsAtual && !obsAtual.includes(itemParaSomar.observacao)) {
                    itemsList[itemParaSomar.indexExistente].observacao = obsAtual + ' | ' + itemParaSomar.observacao;
                } else if (!obsAtual) {
                    itemsList[itemParaSomar.indexExistente].observacao = itemParaSomar.observacao;
                }
            }
            
            renderItems();
            atualizarListaItensModal();
            resetModal();
            itemParaSomar = null;
        }
        $('#modalSomarQuantidade').modal('hide');
        // Fecha também o modal principal após somar
        $('#addItemModal').modal('hide');
    });
    
    function adicionarItemNaLista(selectedItem, quantidade) {
        itemsList.push({
            item_id: selectedItem.id,
            descricao: selectedItem.descricao,
            unidade: selectedItem.unidade__sigla,
            quantidade: quantidade,
            observacao: document.getElementById('observacaoInput').value.trim()
        });
        
        renderItems();
        atualizarListaItensModal();
        resetModal();
        
        // Fecha o modal após adicionar o item
        $('#addItemModal').modal('hide');
    }

    function renderItems() {
        itemsListContainer.innerHTML = '';
        if (itemsList.length > 0) {
            placeholder.style.display = 'none';
            itemsList.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-adicionado mb-2 d-flex justify-content-between align-items-center';
                itemDiv.innerHTML = `<div class="d-flex flex-column me-3"><div class="item-descricao text-truncate text-dark">${item.descricao}</div><small class="text-muted">${item.quantidade} ${item.unidade}</small></div><div><button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}"><i class="fas fa-trash"></i></button></div>`;
                itemsListContainer.appendChild(itemDiv);
            });
        } else {
            placeholder.style.display = 'flex';
        }
        itemCountSpan.textContent = itemsList.length;
    }

    function resetModal() {
        itemCatalogoSelect.val(null).trigger('change');
        document.getElementById('itemDetails').classList.add('d-none');
        document.getElementById('itemPlaceholder').classList.remove('d-none');
        document.getElementById('quantidadeInput').value = '';
        document.getElementById('observacaoInput').value = '';
        $('#avisoDuplicado').addClass('d-none');
        // NÃO fecha o modal para facilitar adição de múltiplos itens
    }
    
    itemsListContainer.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-item-btn');
        if (removeBtn) {
            const index = removeBtn.getAttribute('data-index');
            itemsList.splice(index, 1);
            renderItems();
        }
    });
    
    mainForm.addEventListener('submit', function(e) {
        if (itemsList.length === 0) {
            e.preventDefault();
            alert('Você precisa adicionar pelo menos um item à solicitação.');
            return;
        }
        hiddenInput.value = JSON.stringify(itemsList);
    });
});
</script>
{% endblock %}