{% extends 'materiais/base.html' %}
{% block title %}Confirmar Envios de Cotação{% endblock %}

{% block content %}
<style>
    /* Estilos seguindo o padrão de dashboard do projeto */
    .copy-card { transition: all 0.3s ease; border: 1px solid #dee2e6; background-color: #fff; }
    .copy-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: #0d6efd; }
    .label-mini { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; font-weight: bold; margin-bottom: 0.2rem; }
    .text-preview { background-color: #fcfcfc; border: 1px solid #e9ecef; border-radius: 6px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; white-space: pre-wrap; font-size: 0.88rem; line-height: 1.5; color: #333; }
    .whatsapp-btn { background-color: #25d366; color: white; border: none; }
    .whatsapp-btn:hover { background-color: #1ebe57; color: white; }
    .toast-custom { position: fixed; bottom: 20px; start: 50%; transform: translateX(-50%); z-index: 9999; background: #333; color: #fff; padding: 10px 25px; border-radius: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; }
</style>

<div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center">
        <button onclick="fecharAba()" class="btn btn-secondary me-3 shadow-sm">
            <i class="fas fa-times"></i> Fechar Aba
        </button>
        <div>
            <h4 class="mb-0">Central de Envio Manual</h4>
            <p class="text-muted mb-0 small">Copie os dados ou chame o fornecedor diretamente no WhatsApp.</p>
        </div>
    </div>
</div>

<div id="copy-toast" class="toast-custom">
    <i class="fas fa-check-circle text-success me-2"></i> <span id="toast-message">Copiado!</span>
</div>

<div class="row">
    {% for envio in envios %}
    <div class="col-md-6 mb-4">
        <div class="card h-100 copy-card shadow-sm border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold text-dark"><i class="fas fa-store me-2 text-primary"></i>{{ envio.fornecedor.nome_fantasia|upper }}</h6>
                <span class="badge bg-light text-dark border">SC {{ envio.solicitacao.numero }}</span>
            </div>
            
            <div class="card-body">
                <div class="mb-3">
                    <label class="label-mini">E-MAIL CADASTRADO</label>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm bg-light" id="email-{{ envio.id }}" value="{{ envio.fornecedor.email|default:'E-mail não cadastrado' }}" readonly>
                        <button class="btn btn-outline-primary btn-sm" onclick="copiarParaAreaTransferencia('email-{{ envio.id }}', 'E-mail copiado!')">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <button class="btn btn-sm whatsapp-btn w-100 fw-bold" onclick="abrirWhatsApp('{{ envio.fornecedor.contato_whatsapp }}', 'text-body-{{ envio.id }}')">
                            <i class="fab fa-whatsapp me-1"></i> WHATSAPP
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-sm btn-primary w-100 fw-bold" onclick="copiarParaAreaTransferencia('text-body-{{ envio.id }}', 'Mensagem copiada!')">
                            <i class="far fa-file-alt me-1"></i> COPIAR TEXTO
                        </button>
                    </div>
                </div>

                <label class="label-mini">MENSAGEM FORMATADA</label>
                <div class="text-preview p-3" id="text-body-{{ envio.id }}">Prezado(a) {{ envio.fornecedor.nome_fantasia }},

A Boa Vista Construtora convida sua empresa a participar da cotação referente à Solicitação de Compra nº {{ envio.solicitacao.numero }}.

DADOS DA SOLICITAÇÃO:
Obra: {{ envio.solicitacao.obra.nome }}
Prazo de Entrega Desejado: {{ envio.solicitacao.data_necessidade|date:"d/m/Y" }}

ITENS SOLICITADOS:
{% for item in envio.itens.all %}- {{ item.quantidade|floatformat:0 }} {{ item.unidade }} de {{ item.descricao }}
{% endfor %}

CONDIÇÕES DE NEGOCIAÇÃO SUGERIDAS:
Forma de Pagamento: {{ envio.get_forma_pagamento_display }}
Prazo de Pagamento: {{ envio.prazo_pagamento }} dias
{% if envio.observacoes %}Observações: {{ envio.observacoes }}
{% endif %}

IMPORTANTE:
Este é um envio manual. Por favor, responda a este contato ou acesse o Portal do Fornecedor para registrar sua proposta:
{{ site_url }}

E-mail de contato: {{ envio.fornecedor.email|default:'(não informado)' }}

Atenciosamente,
Departamento de Compras
Boa Vista Construtora</div>
            </div>

            <div class="card-footer bg-white border-top-0 pb-3">
                <small class="text-muted d-block mb-2 text-center">
                    <i class="fas fa-info-circle me-1"></i>
                    Após enviar a cotação ao fornecedor, clique em "Fechar Aba" no topo da página
                </small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block javascript %}
<script>
    /**
     * Função para copiar texto com fallback para navegadores antigos
     */
    function copiarParaAreaTransferencia(elementId, message) {
        const element = document.getElementById(elementId);
        const textToCopy = (element.tagName === 'INPUT') ? element.value : element.innerText;

        // Tenta usar a API moderna do Clipboard primeiro
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                mostrarToast(message);
            }).catch(err => {
                console.error('Erro ao copiar com Clipboard API: ', err);
                copiarComFallback(textToCopy, message);
            });
        } else {
            // Fallback para navegadores antigos (IE11, etc)
            copiarComFallback(textToCopy, message);
        }
    }

    /**
     * Fallback usando document.execCommand (compatível com IE11)
     */
    function copiarComFallback(text, message) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const success = document.execCommand('copy');
            if (success) {
                mostrarToast(message);
            } else {
                alert('Não foi possível copiar. Por favor, copie manualmente.');
            }
        } catch (err) {
            console.error('Erro ao copiar com execCommand: ', err);
            alert('Não foi possível copiar. Por favor, copie manualmente.');
        } finally {
            document.body.removeChild(textarea);
        }
    }

    /**
     * Abre o WhatsApp com o número formatado no padrão wa.me/55...
     */
    function abrirWhatsApp(phone, textId) {
        if (!phone || phone === 'None' || phone.trim() === '') {
            alert('Atenção: Este fornecedor não possui número de WhatsApp cadastrado.');
            return;
        }

        // Limpa tudo que não for número (parênteses, traços, espaços)
        let cleanPhone = phone.replace(/\D/g, '');

        // Adiciona prefixo 55 se o número tiver tamanho de DDD + Número (10 ou 11 dígitos)
        if (cleanPhone.length === 10 || cleanPhone.length === 11) {
            cleanPhone = '55' + cleanPhone;
        }

        // Captura e codifica o texto
        const messageBody = document.getElementById(textId).innerText;
        const encodedText = encodeURIComponent(messageBody);

        // Abre a URL formatada
        const url = `https://wa.me/${cleanPhone}?text=${encodedText}`;
        window.open(url, '_blank');
    }

    /**
     * Alerta visual de sucesso
     */
    function mostrarToast(message) {
        const toast = document.getElementById('copy-toast');
        document.getElementById('toast-message').innerText = message;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }

    /**
     * Fecha a aba atual (funciona apenas se foi aberta via window.open)
     */
    function fecharAba() {
        window.close();
        // Fallback caso window.close() não funcione (aba não aberta por script)
        setTimeout(() => {
            if (!window.closed) {
                alert('Por favor, feche esta aba manualmente.');
            }
        }, 500);
    }
</script>
{% endblock %}